---
title: "IDeA Tutorial: Body_fat"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")

```


# Effect of UPSTM-Based Decorrelation on Feature Discovery


### Loading the libraries

```{r}
library("FRESA.CAD")
library(readxl)
library(umap)

op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)

```

# IDeA Tutorial

## Material and Methods

Data Source 
https://www.kaggle.com/datasets/fedesoriano/body-fat-prediction-dataset


"Source
The data were generously supplied by Dr. A. Garth Fisher who gave permission to freely distribute the data and use for non-commercial purposes.

Roger W. Johnson
Department of Mathematics & Computer Science
South Dakota School of Mines & Technology
501 East St. Joseph Street
Rapid City, SD 57701

email address: rwjohnso@silver.sdsmt.edu
web address: http://silver.sdsmt.edu/~rwjohnso"


## Loading the Data

```{r}
body_fat <- read.csv("~/GitHub/LatentBiomarkers/Data/BodyFat/BodyFat.csv", header=TRUE)

### Removing density as estimator
body_fat$Density <- NULL

body_fat$BMI <- 10000*body_fat$Weight*0.453592/((body_fat$Height*2.54)^2)
## Removing subjects with data errors
body_fat <- body_fat[body_fat$BMI<=50,]

```

## IDeA unsupervised processing

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

body_fat_Decorrelated <- IDeA(body_fat,thr=0.2,verbose=TRUE)

```

### IDeA Transformation 

the original data into a new set of decorrelated variables

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

  par(cex=0.6,cex.main=0.85,cex.axis=0.7)
  cormat <- cor(body_fat,method="pearson")
  gplots::heatmap.2(abs(cormat),
                    trace = "none",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "Original Correlation",
                    cexRow = 0.75,
                    cexCol = 0.75,
                     srtCol=30,
                     srtRow=60,
                    key.title=NA,
                    key.xlab="|Pearson Correlation|",
                    xlab="Feature", ylab="Feature")

  cormat <- cor(body_fat_Decorrelated,method="pearson")
  gplots::heatmap.2(abs(cormat),
                    trace = "none",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "After IDeA Correlation",
                    cexRow = 0.75,
                    cexCol = 0.75,
                     srtCol=30,
                     srtRow=60,
                    key.title=NA,
                    key.xlab="|Pearson Correlation|",
                    xlab="Feature", ylab="Feature")

```


### Exploring transformation

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

  UPSTM <- attr(body_fat_Decorrelated,"UPSTM")
  
  gplots::heatmap.2(1.0*(abs(UPSTM)>0),
                    trace = "none",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "Decorrelation matrix",
                    cexRow = 0.75,
                    cexCol = 0.75,
                   srtCol=30,
                   srtRow=60,
                    key.title=NA,
                    key.xlab="|Beta|>0",
                    xlab="Output Feature", ylab="Input Feature")
  
```


### The latent Formulas

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}
# Get a list with the latent formulas' coefficients
LatentFormulas <- getLatentCoefficients(body_fat_Decorrelated)

# A string character with the formulas can be obtained by:
charFormulas <- attr(LatentFormulas,"LatentCharFormulas")
pander::pander(as.matrix(charFormulas))

```


### Latent Formulas Interpretation
```{r warning = FALSE, dpi=300, fig.height= 3.5, fig.width= 7.0}

par(mfrow=c(1,2),cex=0.5)

mvbmi <- mean(body_fat_Decorrelated$La_BMI)
range <- max(body_fat$BMI)-min(body_fat$BMI)
ylim <- c(mvbmi-range/2,mvbmi+range/2)
plot(body_fat$BMI,body_fat_Decorrelated$La_BMI,
     ylim=ylim,
     ylab="Latent BMI",
     xlab="True BMI",
     main="IDeA Latent Variable")
BMIformula <- LatentFormulas[["La_BMI"]]
noBMInames <- names(BMIformula)[names(BMIformula) != "BMI"]
predBMI <- -(as.matrix(body_fat[,noBMInames]) %*% BMIformula[noBMInames])
plot(body_fat$BMI,predBMI,xlab="True BMI",ylab="Predicted BMI",main="IDeA Generated Predictions")

mvage <- mean(body_fat_Decorrelated$La_Age)
range <- max(body_fat$Age)-min(body_fat$Age)
ylim <- c(mvage-range/2,mvage+range/2)


plot(body_fat$Age,body_fat_Decorrelated$La_Age,
     ylim=ylim,
     ylab="Latent AGE",
     xlab="True AGE",
     main="IDeA Latent Variable")
Ageformula <- LatentFormulas[["La_Age"]]
noAgenames <- names(Ageformula)[names(Ageformula) != "Age"]
predAge <- -(as.matrix(body_fat[,noAgenames]) %*% Ageformula[noAgenames])
plot(body_fat$Age,predAge,xlab="True Age",ylab="Predicted Age",main="IDeA Generated Predictions")

mvage <- mean(body_fat_Decorrelated$La_Forearm)
range <- max(body_fat$Forearm)-min(body_fat$Forearm)
ylim <- c(mvage-range/2,mvage+range/2)

plot(body_fat$Forearm,body_fat_Decorrelated$La_Forearm,
     ylim=ylim,
     ylab="Latent Forearm",
     xlab="True Forearm",
     main="IDeA Latent Variable")
Forearmformula <- LatentFormulas[["La_Forearm"]]
noForearmnames <- names(Forearmformula)[names(Forearmformula) != "Forearm"]
predForearm <- -(as.matrix(body_fat[,noForearmnames]) %*% Forearmformula[noForearmnames])
plot(body_fat$Forearm,predForearm,xlab="True Forearm",ylab="Predicted Forearm",main="IDeA Generated Predictions")

par(op)

```

## IDeA for Supervised Learning

### Splint into Training Tesiting Sets

```{r}

# 75% for training 25% for testing 
set.seed(1)
trainsamples <- sample(nrow(body_fat),3*nrow(body_fat)/4)

trainingset <- body_fat[trainsamples,]
testingset <- body_fat[-trainsamples,]

```


## Data decorrelation of the train set and prediction of the test set

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

body_fat_Decorrelated_train <- IDeA(trainingset,thr=0.2,Outcome="BodyFat",drivingFeatures="NA")
body_fat_Decorrelated_test <- predictDecorrelate(body_fat_Decorrelated_train,testingset)

```

### Train a regression model for body fat prediction

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

modelBodyFat <- LASSO_1SE(BodyFat~.,body_fat_Decorrelated_train)
pander::pander(as.matrix(modelBodyFat$coef))

bmodl <- BSWiMS.model(BodyFat~.,body_fat_Decorrelated_train,print=TRUE)
pander::pander(as.matrix(bmodl$bagging$bagged.model$coefficients))
sm <- summary(bmodl)
pander::pander(sm$coefficients)

```

### The model coefficients in the observed space
```{r  results = "asis", warning = FALSE}

# Get the coefficients in the observed space
observedCoef <- getObservedCoef(body_fat_Decorrelated_train,modelBodyFat)
pander::pander(as.matrix(observedCoef$coefficients))


```


### Predict using the transformed data set

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

predicBodyFat <- predict(modelBodyFat,body_fat_Decorrelated_test)
rmetrics <- predictionStats_regression(cbind(testingset$BodyFat,predicBodyFat),"Body Fat")
pander::pander(rmetrics)

```

### Prediction using the observed features

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}


predicBodyFatObst <- model.matrix(formula(observedCoef$formula),testingset) %*% observedCoef$coefficients

plot(predicBodyFatObst,predicBodyFat,xlab="Observed",ylab="Latent",main="Observed vs Latent")


```

### Comparison to raw model

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}
rawmodelBodyFat <- LASSO_1SE(BodyFat~.,trainingset)
pander::pander(rawmodelBodyFat$coef)
rawpredicBodyFat <- predict(rawmodelBodyFat,testingset)
rmetrics <- predictionStats_regression(cbind(testingset$BodyFat,rawpredicBodyFat),"Body Fat")
pander::pander(rmetrics)

```

### Comparing the feature significance on the model

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

par(mfrow=c(2,2),cex=0.5)

rawlm <- lm(BodyFat~.,trainingset[,c("BodyFat",names(rawmodelBodyFat$coef)[-1])])
pander::pander(rawlm,add.significance.stars=TRUE)
plot(rawlm)

par(mfrow=c(2,2),cex=0.5)
Delm <- lm(BodyFat~.,body_fat_Decorrelated_train[,c("BodyFat",names(modelBodyFat$coef)[-1])])
pander::pander(Delm,add.significance.stars=TRUE)
plot(Delm)

par(op)
```


## Train a regression model for Overweight prediction

### First remove Height and Weight from training and testing sets

```{r}

trainingsetBMI <- trainingset[,!(colnames(trainingset) %in% c("Weight","Height"))]
testingsetBMI <- testingset[,!(colnames(trainingset) %in% c("Weight","Height"))]
trainingsetBMI$Overweight <- 1*(trainingsetBMI$BMI>=25)
testingsetBMI$Overweight <- 1*(testingsetBMI$BMI>=25)
trainingsetBMI$BMI <- NULL
testingsetBMI$BMI <- NULL
table(trainingsetBMI$Overweight)
table(testingsetBMI$Overweight)

BMI_Decorrelated_train <- IDeA(trainingsetBMI,thr=0.2,Outcome="Overweight",drivingFeatures="NA")

BMI_Decorrelated_test <- predictDecorrelate(BMI_Decorrelated_train,testingsetBMI)

```

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

modelOverweight <- LASSO_1SE(Overweight~.,BMI_Decorrelated_train,family="binomial")
pander::pander(as.matrix(modelOverweight$coef))


```

### The model coefficients in the observed space
```{r  results = "asis", warning = FALSE}

# Get the coefficients in the observed space
observedCoef <- getObservedCoef(BMI_Decorrelated_train,modelOverweight)
pander::pander(as.matrix(observedCoef$coefficients))


```


### Predict using the transformed data set

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

predicOverweight <- predict(modelOverweight,BMI_Decorrelated_test)
pr <- predictionStats_binary(cbind(BMI_Decorrelated_test$Overweight,predicOverweight),"Overweight")
pander::pander(pr$ClassMetrics)

```

### Prediction using the observed features

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

predicOverweightObst <- model.matrix(formula(observedCoef$formula),testingsetBMI) %*% observedCoef$coefficients
#predicOverweightObst <- 1.0/(1.0 + exp(-predicOverweightObst));

plot(predicOverweightObst,predicOverweight,xlab="Observed",ylab="Latent",main="Observed vs Latent")


```

### Comparison to raw model

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}
rawmodelOverweight <- LASSO_1SE(Overweight~.,trainingsetBMI,family="binomial")
pander::pander(rawmodelOverweight$coef)
rawpredicOverweight <- predict(rawmodelOverweight,testingsetBMI)
pr <- predictionStats_binary(cbind(testingsetBMI$Overweight,rawpredicOverweight),"Overweight")
pander::pander(pr$ClassMetrics)

```


### Comparing the feature significance on the model

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

par(mfrow=c(2,2),cex=0.5)

rawlm <- lm(Overweight~.,trainingsetBMI[,c("Overweight",names(rawmodelOverweight$coef)[-1])])
pander::pander(rawlm,add.significance.stars=TRUE)
plot(rawlm)

par(mfrow=c(2,2),cex=0.5)
Delm <- lm(Overweight~.,BMI_Decorrelated_test[,c("Overweight",names(modelOverweight$coef)[-1])])
pander::pander(Delm,add.significance.stars=TRUE)
plot(Delm)

```

