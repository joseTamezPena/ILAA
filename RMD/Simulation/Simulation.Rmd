---
title: "Simulation_Transform"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")

```


# Validating IDeA as metod to recover the transformation matrix structure

We will simulate a set of sparse random transformations, and we test if IDeA is able to recover the inverse transformation
The data will consist of a set of N random variables half Gaussian, half with uniform distribution.
The transformation matrix will only create a set of 10 correlated variables

### Loading the libraries

```{r}
library("FRESA.CAD")
library(entropy)
library(psych)
library(whitening)
library("vioplot")

op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)

```




## The Data

```{r}
NRandom <- 30
NObser <- 1000
FacRand <- 2
randdata <- matrix(0,nrow=NObser,ncol=NRandom)

for (i in 1:(NRandom/2))
{
  randdata[,i*2-1] <- rnorm(NObser)
  randdata[,i*2] <- 3*(runif(NObser,0,1) - 0.5)
}

print(summary(randdata))
```


## Create a sparse transformation

```{r}
rotmat <- matrix(0,nrow=NRandom,ncol=NRandom);
pupdate <- 0.10
for (i in 1:NRandom)
{
  if (i < NRandom/2)
  {
    for (j in 1:(NRandom/2))
    {
        if (runif(1) < pupdate)
        {
          rotmat[i,j] <- rnorm(1)
        }
    }
  }
  else
  {
    for (j in (NRandom/2+1):NRandom)
    {
        if (runif(1) < pupdate)
        {
          rotmat[i,j] <- rnorm(1)
        }
    }
  }
}
rotmat[abs(rotmat) < 0.1] <- 0
diag(rotmat) <- 1.0

rotmat <- as.data.frame(rotmat)
rownames(rotmat) <- paste("V",rownames(rotmat),sep="")
colnames(rotmat) <- paste("La_",colnames(rotmat),sep="")
rotmat <- as.matrix(rotmat)

```

### heatmap rotation

### Heat map

```{r}

gplots::heatmap.2(abs(rotmat),
                    trace = "none",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "Transformation",
                    cexRow = 0.5,
                    cexCol = 0.5,
                     srtCol=45,
                     srtRow= -45,
                    key.title=NA,
                    key.xlab="Coefficients",
                    xlab="Feature", ylab="Feature")

```


## Rotate the data

```{r}
irotmat <- solve(rotmat)
print(1*(abs(rotmat)>1.0e-3))
print(1*(abs(irotmat)>1.0e-3))
print((irotmat %*% rotmat) > 1.0e-6)

CorrelObs <- as.data.frame(randdata %*% irotmat);

#plot(CorrelObs)
```


### Heat map

```{r}
rawCor <- cor(CorrelObs)

  gplots::heatmap.2(abs(rawCor),
                    trace = "none",
  #                  scale = "row",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "Original Correlation",
                    cexRow = 0.5,
                    cexCol = 0.5,
                     srtCol=45,
                     srtRow= -45,
                    key.title=NA,
                    key.xlab="Pearson Correlation",
                    xlab="Feature", ylab="Feature")

```


### Add random features
```{r}

CorrelObs <- cbind(CorrelObs,matrix(rnorm(FacRand*NRandom*NObser),nrow=NObser,ncol=FacRand*NRandom))
colnames(CorrelObs) <- paste("ER",colnames(CorrelObs),sep="")
colnames(CorrelObs) <- str_replace_all(colnames(CorrelObs),"ERV","V")

```

### IDeA

```{r}

IdeT <- IDeA(CorrelObs,corRank=TRUE,thr=0.5,verbose=TRUE)
#IdeT <- IDeA(CorrelObs,corRank=FALSE,thr=0.5,verbose=TRUE)
#IdeT <- IDeA(CorrelObs,relaxed=FALSE,corRank=FALSE,thr=0.5,verbose=TRUE)
attr(IdeT,"IDeAEvolution")
rmat <- attr(IdeT,"UPSTM")
falsedisc <- str_detect(rownames(rmat),"R")
sum(falsedisc)
rmat <- rmat[!falsedisc,]
falsedisc <- str_detect(colnames(rmat),"R")
sum(falsedisc)
rmat <- rmat[,!falsedisc]

dtran <- IdeT
attr(dtran,"UPSTM") <- rotmat

getLatentCoefficients(dtran)

getLatentCoefficients(IdeT)


rnrotmat <- rotmat
colnames(rnrotmat) <- str_remove_all(colnames(rnrotmat),"La_")
GTassVar <- rnrotmat != 0
GTassVar <- 1*(GTassVar | t(GTassVar))

rnrmat <- rmat
colnames(rnrmat) <- str_remove_all(colnames(rnrmat),"La_")
IDassVar <- rnrmat != 0
IDassVar <- 1*(IDassVar | t(IDassVar))


print(GTassVar)
aux <- IDassVar
IDassVar <- 0*GTassVar
for (rn in rownames(aux))
{
  for (cn in colnames(aux))
  {
    IDassVar[rn,cn] <- aux[rn,cn];
  }
}
diag(IDassVar) <- 1
print(IDassVar)
print(GTassVar==IDassVar)
print(sum(GTassVar==IDassVar)/(NRandom^2))


```

