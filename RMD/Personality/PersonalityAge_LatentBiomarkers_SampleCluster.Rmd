---
title: "Decorrelation-Based Feature Discovery: Personality Age"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")

```


# Effect of UPSTM-Based Decorrelation on Feature Discovery


## Loading the libraries

```{r}
library("FRESA.CAD")
library(readxl)
library(igraph)
library(umap)
library(tsne)
library(entropy)

op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)

```


## Material 

Data Source 
https://quantdev.ssri.psu.edu/tutorials/intro-basic-exploratory-factor-analysis

"For this example, we use data from the web that are collected and distributed at https://openpsychometrics.org/_rawdata/. The data were obtained from 19,719 participants (rows) who provided answers to the Big Five Personality Test, constructed with items from the International Personality Item Pool. Data columns include gender, age, race, native language, country, and answers to the 50 likert rated statements (1-5;0 if missed; 1 was labeled as “strongly disagree”, 2 was labeled as “disagree”, 3 was labeled as “neither agree not disagree”, 4 was labeled as “agree” and 5 was labeled as “strongly agree”.) The original files can be obtaned at http://openpsychometrics.org/_rawdata/BIG5.zip"



## The Data

```{r}
BigData <- as.data.frame(read_excel("~/GitHub/LatentBiomarkers/Data/BigData.xlsx"))

BigData[BigData==0] <- NA 
BigData <- BigData[complete.cases(BigData),]
BigData <- BigData[BigData$age<100,]

BigData <- BigData[,-c(1,3,5,6,7)]

BigData$gender <- 1*(BigData$gender==1)


BigData$age <- log10(BigData$age)

```

### Standarize the names for the reporting

```{r results = "asis"}
studyName <- "PersonalityAge"
dataframe <- as.data.frame(t(BigData[sample(nrow(BigData),200),]))
colnames(dataframe) <- paste("S",colnames(dataframe),sep="")

thro <- 0.20
cexheat <- 0.15

```


###  Decorrelating using ILAA

ILAA bootstrapped training and testing sets

```{r results = "asis", warning = FALSE}
trainage_DE <- ILAA(dataframe,thr=0.2,verbose=TRUE,bootstrap=30)

```


### Formulas Network

Displaying the features associations

```{r  results = "asis", warning = FALSE, dpi=300, fig.height= 6.0, fig.width= 6.0}
par(op)

  transform <- attr(trainage_DE,"UPLTM") != 0
  colnames(transform) <- str_remove_all(colnames(transform),"La_")
  transform <- abs(transform*cor(dataframe[,rownames(transform)])) # The weights are proportional to the observed correlation
  
  
  VertexSize <- attr(trainage_DE,"fscore") # The size depends on the variable independence relevance (fscore)
  names(VertexSize) <- str_remove_all(names(VertexSize),"La_")
  VertexSize <- 10*(VertexSize-min(VertexSize))/(max(VertexSize)-min(VertexSize)) # Normalization
  
  gr <- graph_from_adjacency_matrix(transform,mode = "directed",diag = FALSE,weighted=TRUE)
  gr$layout <- layout_with_fr
  
  fc <- cluster_optimal(gr)
  plot(fc, gr,
       edge.width = 2*E(gr)$weight,
       vertex.size=VertexSize,
       edge.arrow.size=0.5,
       edge.arrow.width=0.75,
       vertex.label.cex=0.5,
       vertex.label.dist=1,
       main="Feature Association")

par(op)

      varratios <- attr(trainage_DE,"VarRatio")
      names(varratios) <- str_remove_all(names(varratios),"La_")
      fscores <- attr(trainage_DE,"fscore") 
      names(fscores) <- str_remove_all(names(fscores),"La_")
      clustable <- as.data.frame(cbind(Variable=fc$names,
                                       Formula=as.character(theCharformulas[paste("La_",fc$names,sep="")]),
                                       Cluster=fc$membership,
                                       ResidualVariance=round(varratios[fc$names],3),
                                       Fscore=round(fscores[fc$names],3)
                                       )
                                 )
      rownames(clustable) <- str_replace_all(rownames(clustable),"__","_")
      clustable$Variable <- NULL
      clustable$Cluster <- as.integer(clustable$Cluster)
      clustable$ResidualVariance <- as.numeric(clustable$ResidualVariance)
      clustable$Fscore <- as.numeric(clustable$Fscore)
      clustable <- clustable[order(-clustable$Fscore),]
      clustable <- clustable[order(clustable$Cluster),]

pander::pander(as.matrix(clustable))
```

