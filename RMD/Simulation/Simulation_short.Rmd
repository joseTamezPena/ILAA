---
title: "Simulation_Transform"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")
```



# Validating ILAA as metod to recover the transformation matrix structure

We will simulate a set of sparse random transformations, and we test if ILAA is able to recover the inverse transformation
The data will consist of a set of N random variables half Gaussian, half with uniform distribution.
The transformation matrix will only create a set of 10 correlated variables

### Loading the libraries

```{r}
library("FRESA.CAD")
library(entropy)
library(psych)
library(whitening)
library("vioplot")

op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)
source("~/GitHub/LatentBiomarkers/SimulatedDataFunctions.R")

```

### Simulation parameters

```{r}
NUmberofSimulations = 100

## Simulation parameters
NumOfObs  <- 1000
NumOfCorFeatures <- 40
randomToCorrelRatio <- 1
pOfnoZero <- 0.25
bootstraps <- 30

## ILAA parameters
thr <- 0.40
method <- "pearson"
type <- "LM"

thrvals <- c(0.10,0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90)


```


## Lets run simulations

### Testing the differences in parameters
```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

falseDiscoveryT <- numeric(NUmberofSimulations)
DiscoveryAccuracyT <- numeric(NUmberofSimulations)
DiscoverySenT <- numeric(NUmberofSimulations)
DiscoverySpeT <- numeric(NUmberofSimulations)
trainCorT <- numeric(NUmberofSimulations)
testCorT <- numeric(NUmberofSimulations)

falseDiscoveryB <- numeric(NUmberofSimulations)
DiscoveryAccuracyB <- numeric(NUmberofSimulations)
DiscoverySenB <- numeric(NUmberofSimulations)
DiscoverySpeB <- numeric(NUmberofSimulations)
trainCorB <- numeric(NUmberofSimulations)
testCorB <- numeric(NUmberofSimulations)

falseDiscoveryST <- numeric(NUmberofSimulations)
DiscoveryAccuracyST <- numeric(NUmberofSimulations)
DiscoverySenST <- numeric(NUmberofSimulations)
DiscoverySpeST <- numeric(NUmberofSimulations)
trainCorST <- numeric(NUmberofSimulations)
testCorST <- numeric(NUmberofSimulations)

falseDiscoverySB <- numeric(NUmberofSimulations)
DiscoveryAccuracySB <- numeric(NUmberofSimulations)
DiscoverySenSB <- numeric(NUmberofSimulations)
DiscoverySpeSB <- numeric(NUmberofSimulations)
trainCorSB <- numeric(NUmberofSimulations)
testCorSB <- numeric(NUmberofSimulations)

overlapTF <- numeric(NUmberofSimulations)
overlapSTSB <- numeric(NUmberofSimulations)
overlapTST <- numeric(NUmberofSimulations)
overlapFST <- numeric(NUmberofSimulations)
overlapTSB <- numeric(NUmberofSimulations)
overlapFSB <- numeric(NUmberofSimulations)


i = 1
for (i in 1:NUmberofSimulations)
{
  cat(".")
  if (i %% 10 == 0) cat("\n")
  syndata <- SyntheticData(NumOfObs=NumOfObs,NumOfCorFeatures=NumOfCorFeatures,randomToCorrelRatio=randomToCorrelRatio,pOfnoZero=-pOfnoZero)
  
  trainSample <- sample(NumOfObs,NumOfObs/2)
  cat("T")

  evalILAAPear <- ILAAEvaluation(traindata=syndata$data[trainSample,],
                                 testdata=syndata$data[-trainSample,],
                                 trueRotation=syndata$rotMatrix,
                                 method=method,
                                 Bootstrap=0,
                                 thr=thr)

  trainCorT[i] <- evalILAAPear$trainCorrelation
  testCorT[i] <- evalILAAPear$testCorrelation
  falseDiscoveryT[i] <- evalILAAPear$falseDiscovery
  DiscoveryAccuracyT[i] <- evalILAAPear$DiscoveryAccuracy
  DiscoverySenT[i] <- evalILAAPear$DiscoverySen
  DiscoverySpeT[i] <- evalILAAPear$DiscoverySpe
  

  cat("F")
  evalILAABoot <- ILAAEvaluation(traindata=syndata$data[trainSample,],
                                 testdata=syndata$data[-trainSample,],
                                 trueRotation=syndata$rotMatrix,
                                 method=method,
                                 Bootstrap=bootstraps,
                                 thr=thr)

  trainCorB[i] <- evalILAABoot$trainCorrelation
  testCorB[i] <- evalILAABoot$testCorrelation
  falseDiscoveryB[i] <- evalILAABoot$falseDiscovery
  DiscoveryAccuracyB[i] <- evalILAABoot$DiscoveryAccuracy
  DiscoverySenB[i] <- evalILAABoot$DiscoverySen
  DiscoverySpeB[i] <- evalILAABoot$DiscoverySpe

  cat("t")
  evalILAASpearman <- ILAAEvaluation(traindata=syndata$data[trainSample,],
                                 testdata=syndata$data[-trainSample,],
                                 trueRotation=syndata$rotMatrix,
                                 method="spearman",
                                 Bootstrap=0,
                                 thr=thr)
  
  trainCorST[i] <- evalILAASpearman$trainCorrelation
  testCorST[i] <- evalILAASpearman$testCorrelation
  falseDiscoveryST[i] <- evalILAASpearman$falseDiscovery
  DiscoveryAccuracyST[i] <- evalILAASpearman$DiscoveryAccuracy
  DiscoverySenST[i] <- evalILAASpearman$DiscoverySen
  DiscoverySpeST[i] <- evalILAASpearman$DiscoverySpe

  cat("f")
  evalILAASpearmanBoot <- ILAAEvaluation(traindata=syndata$data[trainSample,],
                                 testdata=syndata$data[-trainSample,],
                                 trueRotation=syndata$rotMatrix,
                                 method="spearman",
                                 Bootstrap=bootstraps/3,
                                 thr=thr)
  
  trainCorSB[i] <- evalILAASpearmanBoot$trainCorrelation
  testCorSB[i] <- evalILAASpearmanBoot$testCorrelation
  falseDiscoverySB[i] <- evalILAASpearmanBoot$falseDiscovery
  DiscoveryAccuracySB[i] <- evalILAASpearmanBoot$DiscoveryAccuracy
  DiscoverySenSB[i] <- evalILAASpearmanBoot$DiscoverySen
  DiscoverySpeSB[i] <- evalILAASpearmanBoot$DiscoverySpe


  sizeMat <- nrow(evalILAAPear$UsedBetas)^2
  overlapTF[i] <- sum(evalILAAPear$UsedBetas == evalILAABoot$UsedBetas)/sizeMat
  overlapSTSB[i] <- sum(evalILAASpearman$UsedBetas == evalILAASpearmanBoot$UsedBetas)/sizeMat
  overlapTST[i] <- sum(evalILAAPear$UsedBetas == evalILAASpearman$UsedBetas)/sizeMat
  overlapFST[i] <- sum(evalILAABoot$UsedBetas == evalILAASpearman$UsedBetas)/sizeMat
  overlapTSB[i] <- sum(evalILAAPear$UsedBetas == evalILAASpearmanBoot$UsedBetas)/sizeMat
  overlapFSB[i] <- sum(evalILAABoot$UsedBetas == evalILAASpearmanBoot$UsedBetas)/sizeMat
  
}
par(cex=0.8,cex.main=0.85,cex.axis=0.9)

vioplot(list(Pearson=DiscoveryAccuracyT,Pearson_P=DiscoveryAccuracyB,Spearman=DiscoveryAccuracyST,Spearman_P=DiscoveryAccuracySB),
        main="Accuracy",ylab="Accuracy",col=c("red","blue"))
vioplot(list(Pearson=DiscoverySenT,Pearson_P=DiscoverySenB,Spearman=DiscoverySenST,Spearman_P=DiscoverySenSB),
        main="Sensitivity",ylab="Sensitivity",col=c("red","blue"))
vioplot(list(Pearson=DiscoverySpeT,Pearson_P=DiscoverySpeB,Spearman=DiscoverySpeST,Spearman_P=DiscoverySpeSB),
        main="Specificity",ylab="Specificity",col=c("red","blue"))
boxplot(list(P_PP=overlapTF,
             S_SP=overlapSTSB,
             P_S=overlapTST,
             PP_S=overlapFST,
             P_SP=overlapTSB,
             PP_SP=overlapFSB),
        main="Overlap",
        ylab="Overlap")
boxplot(list(Pearson=trainCorT,Pearson_P=trainCorB,Spearman=trainCorST,Spearman_P=trainCorSB),
        main="Train Correlation",
        ylab="Correlation")
boxplot(list(Pearson=testCorT,Pearson_P=testCorB,Spearman=testCorST,Spearman_P=testCorSB),
        main="Test Correlation",
        ylab="Correlation")


pander::pander(summary(DiscoveryAccuracyT),caption="Accuracy Pearson")
pander::pander(summary(DiscoveryAccuracyB),caption="Accuracy Pearson: Perturbation")
pander::pander(summary(DiscoveryAccuracyST),caption="Accuracy Spearman")
pander::pander(summary(DiscoveryAccuracySB),caption="Accuracy Spearman: Perturbation")

pander::pander(summary(DiscoverySenT),caption="Sensitivity Pearson")
pander::pander(summary(DiscoverySenB),caption="Sensitivity Pearson: Perturbation")
pander::pander(summary(DiscoverySenST),caption="Sensitivity Spearman")
pander::pander(summary(DiscoverySenSB),caption="Sensitivity Spearman: Perturbation")

pander::pander(summary(DiscoverySpeT),caption="Specifity Pearson")
pander::pander(summary(DiscoverySpeB),caption="Specifity Pearson: Perturbation")
pander::pander(summary(DiscoverySpeST),caption="Specifity Spearman")
pander::pander(summary(DiscoverySpeSB),caption="Specifity Spearman: Perturbation")

pander::pander(summary(trainCorT),caption="Pearson Correlation")
pander::pander(summary(trainCorB),caption="Pearson Correlation: Perturbation")
pander::pander(summary(trainCorST),caption="Spearman Correlation")
pander::pander(summary(trainCorSB),caption="Spearman Correlation Spearman: Perturbation")

pander::pander(summary(testCorT),caption="Test: Pearson Correlation")
pander::pander(summary(testCorB),caption="Test: Pearson Correlation: Perturbation")
pander::pander(summary(testCorST),caption="Test: Spearman Correlation")
pander::pander(summary(testCorSB),caption="Test: Spearman Correlation Spearman: Perturbation")


```


### Testing the effect of the threshold
```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}



falseDiscovery <- matrix(0,nrow=NUmberofSimulations,ncol=length(thrvals))
DiscoveryAccuracy <- falseDiscovery
DiscoverySen <- falseDiscovery
DiscoverySpe <- falseDiscovery
trainCor <- falseDiscovery
testCor <- falseDiscovery
rotSparcity <- falseDiscovery

trueSpacity <- numeric(NUmberofSimulations)
i = 1
for (i in 1:NUmberofSimulations)
{
  cat(".")
  if (i %% 10 == 0) cat("\n")
  syndata <- SyntheticData(NumOfObs=NumOfObs,
                           NumOfCorFeatures=NumOfCorFeatures,
                           randomToCorrelRatio=randomToCorrelRatio,
                           pOfnoZero=-pOfnoZero)
  

  trueSpacity[i] <- sum(syndata$rotMatrix==0)/(NumOfCorFeatures^2)
  trainSample <- sample(NumOfObs,NumOfObs/2)
  cn <- 1;
  for (thr in thrvals)
  {
    cat("T")
    evalILAA <- ILAAEvaluation(traindata=syndata$data[trainSample,],
                                   testdata=syndata$data[-trainSample,],
                                   trueRotation=syndata$rotMatrix,
                                   method=method,
                                   Bootstrap=0,
                                   thr=thr)
    trainCor[i,cn] <- evalILAA$trainCorrelation
    testCor[i,cn] <- evalILAA$testCorrelation
    falseDiscovery[i,cn] <- evalILAA$falseDiscovery
    DiscoveryAccuracy[i,cn] <- evalILAA$DiscoveryAccuracy
    DiscoverySen[i,cn] <- evalILAA$DiscoverySen
    DiscoverySpe[i,cn] <- evalILAA$DiscoverySpe

    rotSparcity[i,cn] <- sum(evalILAA$UPLTM==0)/(ncol(evalILAA$UPLTM)^2)
    cn <- cn + 1;
  }
}
DiscoveryAccuracy <- as.data.frame(DiscoveryAccuracy)
colnames(DiscoveryAccuracy) <- paste("At_",thrvals,sep="")

DiscoverySen <- as.data.frame(DiscoverySen)
colnames(DiscoverySen) <- colnames(DiscoveryAccuracy)
DiscoverySpe <- as.data.frame(DiscoverySpe)
colnames(DiscoverySpe) <- colnames(DiscoveryAccuracy)

trainCor <- as.data.frame(trainCor)
colnames(trainCor) <- colnames(DiscoveryAccuracy)

testCor <- as.data.frame(testCor)
colnames(testCor) <- colnames(DiscoveryAccuracy)

falseDiscovery <- as.data.frame(falseDiscovery)
colnames(falseDiscovery) <- colnames(DiscoveryAccuracy)


rotSparcity <- as.data.frame(rotSparcity)
colnames(rotSparcity) <- colnames(DiscoveryAccuracy)
rotSparcity <- cbind(rotSparcity,True=trueSpacity)

par(cex=0.8,cex.main=0.85,cex.axis=0.9)

boxplot(DiscoveryAccuracy,main="Accuracy",ylab="Accuracy",ylim=c(0.5,1))
boxplot(DiscoverySen,main="Sensitivity",ylab="Sensitivity",ylim=c(0,1))
boxplot(DiscoverySpe,main="Specificity",ylab="Specificity",ylim=c(0,1))
boxplot(0.5*(DiscoverySpe+DiscoverySen),main="Balanced Accuracy",ylab="BACC",ylim=c(0.5,1))
boxplot(falseDiscovery,main="False Discoveries",ylab="Number of False Discoveries")
boxplot(rotSparcity,main="Rotation Matrix Sparcity",ylab="Sparcity")

pander::pander(summary(DiscoveryAccuracy))


ylim <- c(thrvals[1],thrvals[length(thrvals)])
boxplot(trainCor,main="Train Correlation",ylab="Correlation")
lines(c(1,length(thrvals)),ylim)
boxplot(testCor,main="Test Correlation",ylab="Correlation",ylim=ylim)
lines(c(1,length(thrvals)),ylim)



pander::pander(summary(DiscoveryAccuracy),caption="Accuracy")
pander::pander(summary(DiscoverySen),caption="Sensitivity")
pander::pander(summary(DiscoverySpe),caption="Specificity")
pander::pander(summary(0.5*(DiscoverySpe+DiscoverySen)),caption="Balanced Accuracy")

pander::pander(summary(falseDiscovery),caption="False Discovery")
pander::pander(summary(rotSparcity),caption="Spaccity")
pander::pander(summary(trainCor),caption="Train Correlation")
pander::pander(summary(testCor),caption="Test Correlation")






```


### Testing the effect of the threshold with bootstrap

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}


falseDiscoveryB <- matrix(0,nrow=NUmberofSimulations,ncol=length(thrvals))
DiscoveryAccuracyB <- falseDiscoveryB
DiscoverySenB <- falseDiscoveryB
DiscoverySpeB <- falseDiscoveryB
trainCorB <- falseDiscoveryB
testCorB <- falseDiscoveryB
rotSparcityB <- falseDiscoveryB

trueSpacityB <- numeric(NUmberofSimulations)
i = 1
for (i in 1:NUmberofSimulations)
{
  cat(".")
  if (i %% 10 == 0) cat("\n")

  syndata <- SyntheticData(NumOfObs=NumOfObs,
                           NumOfCorFeatures=NumOfCorFeatures,
                           randomToCorrelRatio=randomToCorrelRatio,
                           pOfnoZero= -pOfnoZero)
  
  trueSpacity[i] <- sum(syndata$rotMatrix==0)/(NumOfCorFeatures^2)
  trainSample <- sample(NumOfObs,NumOfObs/2)
  cn <- 1;
  for (thr in thrvals)
  {
    cat("T")
    evalILAA <- ILAAEvaluation(traindata=syndata$data[trainSample,],
                                   testdata=syndata$data[-trainSample,],
                                   trueRotation=syndata$rotMatrix,
                                   method=method,
                                   Bootstrap=bootstraps,
                                   thr=thr)
    
    trainCorB[i,cn] <- evalILAA$trainCorrelation
    testCorB[i,cn] <- evalILAA$testCorrelation
    falseDiscoveryB[i,cn] <- evalILAA$falseDiscovery
    DiscoveryAccuracyB[i,cn] <- evalILAA$DiscoveryAccuracy
    DiscoverySenB[i,cn] <- evalILAA$DiscoverySen
    DiscoverySpeB[i,cn] <- evalILAA$DiscoverySpe

    rotSparcityB[i,cn] <- sum(evalILAA$UPLTM==0)/(ncol(evalILAA$UPLTM)^2)
    cn <- cn + 1;
  }
}
DiscoveryAccuracyB <- as.data.frame(DiscoveryAccuracyB)
colnames(DiscoveryAccuracyB) <- paste("At_",thrvals,sep="")

DiscoverySenB <- as.data.frame(DiscoverySenB)
colnames(DiscoverySenB) <- colnames(DiscoveryAccuracyB)
DiscoverySpeB <- as.data.frame(DiscoverySpeB)
colnames(DiscoverySpeB) <- colnames(DiscoveryAccuracyB)

trainCorB <- as.data.frame(trainCorB)
colnames(trainCorB) <- colnames(DiscoveryAccuracyB)

testCorB <- as.data.frame(testCorB)
colnames(testCorB) <- colnames(DiscoveryAccuracyB)

falseDiscoveryB <- as.data.frame(falseDiscoveryB)
colnames(falseDiscoveryB) <- colnames(DiscoveryAccuracyB)


rotSparcityB <- as.data.frame(rotSparcityB)
colnames(rotSparcityB) <- colnames(DiscoveryAccuracyB)
rotSparcityB <- cbind(rotSparcityB,True=trueSpacity)
par(cex=0.8,cex.main=0.85,cex.axis=0.9)

boxplot(DiscoveryAccuracyB,main="Accuracy",ylab="Accuracy",ylim=c(0.5,1))
boxplot(DiscoverySenB,main="Sensitivity",ylab="Sensitivity",ylim=c(0,1))
boxplot(DiscoverySpeB,main="Specificity",ylab="Specificity",ylim=c(0,1))
boxplot(0.5*(DiscoverySpeB+DiscoverySenB),main="Balanced Accuracy",ylab="BACC",ylim=c(0.5,1))
boxplot(falseDiscoveryB,main="False Discoveries",ylab="Number of False Discoveries")
boxplot(rotSparcityB,main="Rotation Matrix Sparcity",ylab="Sparcity")



ylim <- c(thrvals[1],thrvals[length(thrvals)])
boxplot(trainCorB,main="Train Correlation",ylab="Correlation")
lines(c(1,length(thrvals)),ylim)
boxplot(testCorB,main="Test Correlation",ylab="Correlation")
lines(c(1,length(thrvals)),ylim)

allSen <- cbind(DiscoverySen,DiscoverySenB)
unsortednames <- c(colnames(DiscoverySen),paste(colnames(DiscoverySen),"B",sep="_"))
colnames(allSen) <- unsortednames
ordernames <- colnames(allSen)[order(colnames(allSen))]
allSen <- allSen[ordernames]
vioplot(allSen,col=c("red","blue"),main="Sensitivity",ylab="Sensitivity",xlab="Target Correlation")
legend("topright",legend=c("Default","Stocastic"),
             lty = 1,
             col=c("red","blue"))

allSpe <- cbind(DiscoverySpe,DiscoverySpeB)
colnames(allSpe) <- unsortednames
allSpe <- allSpe[ordernames]
vioplot(allSpe,col=c("red","blue"),main="Specificity",ylab="Specificity",xlab="Target Correlation")
legend("bottomright",legend=c("Default","Stocastic"),
             lty = 1,
             col=c("red","blue"))

allBACC <- cbind(0.5*(DiscoverySpe+DiscoverySen),0.5*(DiscoverySpeB+DiscoverySenB))
colnames(allBACC) <- unsortednames
allBACC <- allBACC[ordernames]
vioplot(allBACC,col=c("red","blue"),main="Balanced Accuracy",ylab="Balanced Accuraccy",xlab="Target Correlation")
legend("topright",legend=c("Default","Stocastic"),
             lty = 1,
             col=c("red","blue"))



pander::pander(summary(DiscoveryAccuracyB),caption="Accuracy")
pander::pander(summary(DiscoverySenB),caption="Sensitivity")
pander::pander(summary(DiscoverySpeB),caption="Specificity")
pander::pander(summary(0.5*(DiscoverySpeB+DiscoverySenB)),caption="Balanced Accuracy")

pander::pander(summary(falseDiscoveryB),caption="False Discovery")
pander::pander(summary(rotSparcityB),caption="Spaccity")
pander::pander(summary(trainCorB),caption="Train Correlation")
pander::pander(summary(testCorB),caption="Test Correlation")


```

