---
title: "IDeA Tutorial: Body_fat"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")

```


# Effect of UPSTM-Based Decorrelation on Feature Discovery


### Loading the libraries

```{r}
library("FRESA.CAD")
library(readxl)
library(umap)

op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)

```

# IDeA Tutorial

## Material and Methods

Data Source 
https://www.kaggle.com/datasets/fedesoriano/body-fat-prediction-dataset


"Source
The data were generously supplied by Dr. A. Garth Fisher who gave permission to freely distribute the data and use for non-commercial purposes.

Roger W. Johnson
Department of Mathematics & Computer Science
South Dakota School of Mines & Technology
501 East St. Joseph Street
Rapid City, SD 57701

email address: rwjohnso@silver.sdsmt.edu
web address: http://silver.sdsmt.edu/~rwjohnso"


## Loading the Data

```{r}
body_fat <- read.csv("~/GitHub/LatentBiomarkers/Data/BodyFat/BodyFat.csv", header=TRUE)

### Removing density as estimator
body_fat$Density <- NULL

body_fat$BMI <- 10000*body_fat$Weight*0.453592/((body_fat$Height*2.54)^2)
## Removing subjects with data errors
body_fat <- body_fat[body_fat$BMI<=50,]

```

## IDeA Totally unsupervised processing

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

body_fat_Decorrelated <- IDeA(body_fat,thr=0.2)

```

### IDeA Transforms the original data into a new set of decorrelated variables

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

  par(cex=0.6,cex.main=0.85,cex.axis=0.7)
  cormat <- cor(body_fat,method="pearson")
  gplots::heatmap.2(abs(cormat),
                    trace = "none",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "Original Correlation",
                    cexRow = 0.75,
                    cexCol = 0.75,
                     srtCol=30,
                     srtRow=60,
                    key.title=NA,
                    key.xlab="|Pearson Correlation|",
                    xlab="Feature", ylab="Feature")

  cormat <- cor(body_fat_Decorrelated,method="pearson")
  gplots::heatmap.2(abs(cormat),
                    trace = "none",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "After IDeA Correlation",
                    cexRow = 0.75,
                    cexCol = 0.75,
                     srtCol=30,
                     srtRow=60,
                    key.title=NA,
                    key.xlab="|Pearson Correlation|",
                    xlab="Feature", ylab="Feature")

```


### The transformation

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

  UPSTM <- attr(body_fat_Decorrelated,"UPSTM")
  
  gplots::heatmap.2(1.0*(abs(UPSTM)>0),
                    trace = "none",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "Decorrelation matrix",
                    cexRow = 0.75,
                    cexCol = 0.75,
                   srtCol=30,
                   srtRow=60,
                    key.title=NA,
                    key.xlab="|Beta|>0",
                    xlab="Output Feature", ylab="Input Feature")
  
```


### The latent Formulas

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}
# Get a list with the latent formulas' coefficients
LatentFormulas <- getLatentCoefficients(body_fat_Decorrelated)

# A string character with the formulas can be obtained by:
charFormulas <- attr(LatentFormulas,"LatentCharFormulas")
pander::pander(as.matrix(charFormulas))

```


### Latent Formulas Interpretation
```{r warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

Ageformula <- LatentFormulas[["La_Age"]]
noAgenames <- names(Ageformula)[names(Ageformula) != "Age"]
predAge <- -(as.matrix(body_fat[,noAgenames]) %*% Ageformula[noAgenames])
plot(body_fat$Age,predAge,xlab="True Age",ylab="Predicted Age",main="IDeA Generated Predictions")

BMIformula <- LatentFormulas[["La_BMI"]]
noBMInames <- names(BMIformula)[names(BMIformula) != "BMI"]
predBMI <- -(as.matrix(body_fat[,noBMInames]) %*% BMIformula[noBMInames])
plot(body_fat$BMI,predBMI,xlab="True BMI",ylab="Predicted BMI",main="IDeA Generated Predictions")

```

## IDeA for Supervised Learning

### Splint into Training Tesiting Sets

```{r}

# 75% for training 25% for testing 

trainsamples <- sample(nrow(body_fat),3*nrow(body_fat)/4)

trainingset <- body_fat[trainsamples,]
testingset <- body_fat[-trainsamples,]

```


```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

body_fat_Decorrelated_train <- IDeA(trainingset,thr=0.2,Outcome="BodyFat",drivingFeatures="NA")
test_body_fat_Decorrelated <- predictDecorrelate(body_fat_Decorrelated_train,testingset)

```

### Train a Logisitc Model for body fat prediction

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

modelBodyFat <- LASSO_1SE(BodyFat~.,body_fat_Decorrelated_train)

```

### The model coefficients in the observed space
```{r  results = "asis", warning = FALSE}
pander::pander(as.matrix(modelBodyFat$coef))

# Get the coefficients in the observed space
observedCoef <- getObservedCoef(body_fat_Decorrelated_train,modelBodyFat$coef)
pander::pander(as.matrix(observedCoef))


```


### Predict using the transformed data set

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

predicBodyFat <- predict(modelBodyFat,test_body_fat_Decorrelated)
plot(testingset$BodyFat,predicBodyFat,xlab="True Body Fat",ylab="Predicted Body Fat",main="Predicted Body Fat")
pander::pander(cor.test(predicBodyFat,testingset$BodyFat))

```

### Prediction using the observed features

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

predicBodyFatObst <- as.matrix(testingset[,names(observedCoef)[-1]]) %*% observedCoef[-1] + observedCoef[1]


plot(testingset$BodyFat,predicBodyFatObst,xlab="True Body Fat",ylab="Predicted Body Fat",main="Predicted Body Fat")
pander::pander(cor.test(predicBodyFat,testingset$BodyFat))

plot(predicBodyFatObst,predicBodyFat,xlab="Observed",ylab="Latent",main="Observed vs Latent")



```

