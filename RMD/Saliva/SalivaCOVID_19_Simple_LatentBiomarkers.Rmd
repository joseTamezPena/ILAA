---
title: "Decorrelation-Based Feature Discovery: IR COVID_19"
author: "Jose Tamez"
date: "2022-10-02"
output:
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")

```

# Effect of UPSTM-Based Decorrelation on Feature Discovery

Here I showcase of to use BSWiMS feature selection/modeling function coupled with Goal Driven Sparse Transformation Matrix (UPSTM) as a pre-processing step to decorrelate highly correlated features. The aim(s) are:

1.  To improve model performance by uncovering the hidden information between correlated features.

2.  To simplify the interpretation of the machine learning models.

This demo will use:

-   *FRESA.CAD::IDeA()*. For Decorrelation of Multidimensional data sets

    -   *FRESA.CAD::getLatentCoefficients()*. For the extraction of the model of the newly discovered of decorrelated features.


-   *heatmap.2()*. For displaying the correlation matrix



### Loading the libraries

```{r}
library("FRESA.CAD")
library(readxl)
library(igraph)
library(umap)
library(tsne)
library(entropy)

op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)

```

## Material and Methods


## Data: The COVID_19 Data-Set

The data to process is described in:

<https://zenodo.org/record/4156647#.Y1bSF3bMKUk>


IR Saliva Testing Dataset


10.5281/zenodo.4156647
<https://doi.org/10.5281/zenodo.4156647>


I added a column to the data identifying the repeated experiments.

```{r}

SalivaIR <- as.data.frame(read_excel("~/GitHub/FCA/Data/SalivaThermal_Source_Data_2.xlsx"))


SalivaIR_set1 <- subset(SalivaIR,RepID==1)
rownames(SalivaIR_set1) <- SalivaIR_set1$ID
SalivaIR_set1$RepID <- NULL
SalivaIR_set1$ID <- NULL
SalivaIR_set1$Ct <- NULL

SalivaIR_set2 <- subset(SalivaIR,RepID==2)
rownames(SalivaIR_set2) <- SalivaIR_set2$ID
SalivaIR_set2$RepID <- NULL
SalivaIR_set2$ID <- NULL
SalivaIR_set2$Ct <- NULL

SalivaIR_set3 <- subset(SalivaIR,RepID==3)
rownames(SalivaIR_set3) <- SalivaIR_set3$ID
SalivaIR_set3$RepID <- NULL
SalivaIR_set3$ID <- NULL
SalivaIR_set3$Ct <- NULL

SalivaIR_Avg <- (SalivaIR_set1 + SalivaIR_set2 + SalivaIR_set3)/3

SalivaIR_d1 <- SalivaIR_Avg[,-1] - SalivaIR_Avg[,c(1:ncol(SalivaIR_Avg)-1)]
SalivaIR_d2 <-  -SalivaIR_d1[,c(1:ncol(SalivaIR_d1)-1)] + SalivaIR_d1[,-1]
colnames(SalivaIR_d2) <- paste("DD",colnames(SalivaIR_d2),sep="_")
colnames(SalivaIR_d1) <- paste("D",colnames(SalivaIR_d1),sep="_")

colnames(SalivaIR_Avg) <- paste("V",colnames(SalivaIR_Avg),sep="_")

SalivaIR_Avg$class <- 1*(str_detect(rownames(SalivaIR_Avg),"P"))
##The fraction of samples in the training set
pander::pander(c(row=nrow(SalivaIR_Avg),col=ncol(SalivaIR_Avg)))

pander::pander(table(SalivaIR_Avg$class))
trainFraction=0.90

SalivaIR_d2$class <- 1*(str_detect(rownames(SalivaIR_d2),"P"))

```

## The heatmap of the data

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

hm <- heatMaps(data=SalivaIR_Avg,
               Outcome="class",
               Scale=TRUE,
               hCluster = "row",
               xlab=expression("Wavenumber (cm)"^"-1"),
               ylab="Sample")
par(op)

```

### The UMAP
```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}
lnames <- c("Neg","Pos")
featnames <- colnames(SalivaIR_Avg)
featnames <- featnames[featnames != "class"]
datasetframe.umap = umap(FRESAScale(SalivaIR_Avg[,featnames])$scaledData,n_components=2)
plot(datasetframe.umap$layout,col=(SalivaIR_Avg$class+1),xlab="U1",ylab="U2",main="UMAP: Original",t='n')
text(datasetframe.umap$layout,labels=lnames[1+SalivaIR_Avg$class],col=(SalivaIR_Avg$class+1))


```


#### Correlation Matrix of the Decorrelated Test Data

The heat map of the testing set.

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

par(cex=0.6,cex.main=0.85,cex.axis=0.7)
cormat <- cor(SalivaIR_Avg[,colnames(SalivaIR_Avg) != "class"],method="pearson")
cormat[is.na(cormat)] <- 0
gplots::heatmap.2(abs(cormat),
                  trace = "none",
#                  scale = "row",
                  mar = c(5,5),
                  col=rev(heat.colors(5)),
                  main = "COVID-19: Infrared Signal Correlation",
                  cexRow = 0.35,
                  cexCol = 0.35,
                  key.title=NA,
                  key.xlab="Pearson Correlation",
                  xlab="Feature", ylab="Feature")

## The decorrelation
deIR <- IDeA(SalivaIR_Avg)

pander::pander(sum(apply(SalivaIR_Avg,2,var)))
pander::pander(sum(apply(deIR,2,var)))
pander::pander(entropy(discretize(unlist(SalivaIR_Avg[,colnames(SalivaIR_Avg) != "class"]), 256)))
pander::pander(entropy(discretize(unlist(deIR[,colnames(deIR) != "class"]), 256)))

cormat <- cor(deIR[,colnames(deIR) != "class"],method="pearson")
cormat[is.na(cormat)] <- 0
gplots::heatmap.2(abs(cormat),
                  trace = "none",
                  mar = c(5,5),
                  col=rev(heat.colors(5)),
                  main = "COVID-19 Correlation after UPSTM",
                  cexRow = 0.35,
                  cexCol = 0.35,
                  key.title=NA,
                  key.xlab="Pearson Correlation",
                  xlab="Feature", ylab="Feature")

par(op)
```



## The heatmap of the decorrelated data

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

hm <- heatMaps(data=deIR,
               Outcome="class",
               Scale=TRUE,
               hCluster = "row",
               xlab=expression("Wavenumber (cm)"^"-1"),
               ylab="Sample")
par(op)

```

### The decorralted UMAP
```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}
featnames <- colnames(deIR)
featnames <- featnames[featnames != "class"]
datasetframe.umap = umap(FRESAScale(deIR[,featnames])$scaledData,n_components=2)
plot(datasetframe.umap$layout,col=(deIR$class+1),xlab="U1",ylab="U2",main="UMAP: After Transformation",t='n')
text(datasetframe.umap$layout,labels=lnames[1+deIR$class],col=(deIR$class+1))

```


### The decorrelation matrix

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

par(cex=0.6,cex.main=0.85,cex.axis=0.7)

UPSTM <- attr(deIR,"UPSTM")

gplots::heatmap.2(log(abs(1000*UPSTM)+1),
                  trace = "none",
                  mar = c(5,5),
                  col=rev(heat.colors(5)),
                  main = "COVID-19 Decorrelation matrix",
                  cexRow = 0.35,
                  cexCol = 0.35,
                  key.title=NA,
                  key.xlab="Log(|1000*Beta|+1)",
                  xlab="Output Feature", ylab="Input Feature")

par(op)

```

### Univariate

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 6.0, fig.width= 5.0}

varlist <- colnames(SalivaIR_Avg)[!(colnames(SalivaIR_Avg) %in% "class")]

univar <- uniRankVar(varlist,
	           "class~1",
	           "class",
	           SalivaIR_Avg)



varlist <- colnames(deIR)[!(colnames(deIR) %in% "class")]

univarDe <- uniRankVar(varlist,
	           "class~1",
	           "class",
	           deIR)



```


### Final Table 

```{r results = "asis"}

univariate_columns <- c("caseMean","caseStd","controlMean","controlStd","controlKSP","ROCAUC","FRes.p")

##topfive
pander::pander(univar$orderframe[c(1:5),univariate_columns])


pwilvalue <- univarDe$orderframe$FRes.p
valroc <- pwilvalue < 0.001


finalTable <- univarDe$orderframe[valroc,univariate_columns]

dc <- getLatentCoefficients(deIR)
fscores <- attr(deIR,"fscore")

theFormulas <- dc[rownames(finalTable)]
deFromula <- character(length(theFormulas))
names(deFromula) <- rownames(finalTable)

dx <- names(deFromula)[1]
for (dx in names(deFromula))
{
  coef <- theFormulas[[dx]]
  cname <- names(theFormulas[[dx]])
  names(cname) <- cname
  for (cf in names(coef))
  {
    if (cf != dx)
    {
      if (coef[cf]>0)
      {
        deFromula[dx] <- paste(deFromula[dx],
                               sprintf("+ %5.3f*%s",coef[cf],cname[cf]))
      }
      else
      {
        deFromula[dx] <- paste(deFromula[dx],
                               sprintf("%5.3f*%s",coef[cf],cname[cf]))
      }
    }
  }
}
orgnamez <- rownames(finalTable)
orgnamez <- str_remove_all(orgnamez,"La_")
finalTable$DecorFormula <- deFromula[rownames(finalTable)]
finalTable$fscores <- fscores[rownames(finalTable)]

pander::pander(finalTable)

```


