---
title: "Decorrelation-Based Feature Discovery: Seeds"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")

```


# Effect of UPSTM-Based Decorrelation on Feature Discovery


### Loading the libraries

```{r}
library("FRESA.CAD")
library(readxl)
library(igraph)
library(umap)
library(tsne)
library(entropy)
library(psych)
library(whitening)
library("vioplot")
library("rpart")

op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)

```

## Material and Methods

Data Source 
https://archive.ics.uci.edu/ml/datasets/seeds


M. Charytanowicz, J. Niewczas, P. Kulczycki, P.A. Kowalski, S. Lukasik, S. Zak, 'A Complete Gradient Clustering Algorithm for Features Analysis of X-ray Images', in: Information Technologies in Biomedicine, Ewa Pietka, Jacek Kawa (eds.), Springer-Verlag, Berlin-Heidelberg, 2010, pp. 15-24.


## The Data

```{r}
seeds <- read.delim("~/GitHub/LatentBiomarkers/Data/seeds_dataset.txt", header=FALSE)
par(cex=0.5)

featnames <- c("area",
               "perimeter",
               "compactness",
               "length_of_kernel",
               "width_of_kernel",
               "asymmetry_coeff",
               "length_ker_groove",
               "class"
)
colnames(seeds) <- featnames
#seeds$class <- 1*(seeds$class == 1)
pander::pander(table(seeds$class))

```


### Standarize the names for the reporting

```{r results = "asis" }
studyName <- "Seeds"
classes <- seeds$class
names(classes) <- paste("SV",rownames(seeds),sep="")
dataframe <- seeds[,colnames(seeds) != "class"]
thro <- 0.25

cexheat <- 0.15
dataframe_FDe <- ILAA(dataframe,thr=thro,verbose=TRUE,bootstrap=30)

dataframe <- as.data.frame(t(scale(dataframe_FDe)))
colnames(dataframe) <- paste("S",colnames(dataframe),sep="")


```


###  Decorrelating using ILAA

ILAA bootstrapped training and testing sets

```{r results = "asis", warning = FALSE}
dataframe_De <- ILAA(dataframe,thr=0.5,verbose=TRUE,bootstrap=30)

```

The heat map of the data

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}
par(op)


  par(cex=0.6,cex.main=0.85,cex.axis=0.7)
  cormat <- cor(dataframe,method="pearson")
  cormat[is.na(cormat)] <- 0
  gplots::heatmap.2(abs(cormat),
                    trace = "none",
  #                  scale = "row",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "Subject Correlation",
                    cexRow = cexheat,
                    cexCol = cexheat,
                     srtCol=45,
                     srtRow=45,
                    key.title=NA,
                    key.xlab="|Pearson Correlation|",
                    xlab="Subject", ylab="Subject")
  diag(cormat) <- 0
  pander::pander(max(abs(cormat)))
par(op)

  par(cex=0.6,cex.main=0.85,cex.axis=0.7)
  cormat <- cor(dataframe_De,method="pearson")
  cormat[is.na(cormat)] <- 0
  gplots::heatmap.2(abs(cormat),
                    trace = "none",
  #                  scale = "row",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "Latent Subject Correlation",
                    cexRow = cexheat,
                    cexCol = cexheat,
                     srtCol=45,
                     srtRow=45,
                    key.title=NA,
                    key.xlab="|Pearson Correlation|",
                    xlab="Latent Subject", ylab="Latent Subject")
  diag(cormat) <- 0
  pander::pander(max(abs(cormat)))
par(op)


```



### Formulas Network

Displaying the features associations

```{r  results = "asis", warning = FALSE, dpi=300, fig.height= 6.0, fig.width= 6.0}
par(op)

  transform <- 1*(attr(dataframe_De,"UPLTM") != 0)
  colnames(transform) <- str_remove_all(colnames(transform),"La_")
  srow <- apply(transform,1,sum) > 2
  rtans <- transform[srow,]
  scol <- apply(rtans,2,sum) > 1*(colnames(rtans) %in% rownames(rtans))
  rtans <- rtans[,scol]
  strans <- unique(c(rownames(rtans),colnames(rtans)))
  transform <- transform[strans,strans]

  transform <- abs(transform*cor(dataframe[,rownames(transform)])) # The weights are proportional to the observed correlation
  
  
    gplots::heatmap.2(as.matrix(transform),
                    trace = "none",
  #                  scale = "row",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "Transformation",
                    cexRow = cexheat,
                    cexCol = cexheat,
                     srtCol=45,
                     srtRow=45,
                    key.title=NA,
                    key.xlab="|Pearson Correlation|",
                    xlab="Latent Subject", ylab="Latent Subject")

par(op)
  
  VertexSize <- attr(dataframe_De,"fscore") # The size depends on the variable independence relevance (fscore)
  names(VertexSize) <- str_remove_all(names(VertexSize),"La_")
  VertexSize <- 0.5 + 9.5*(VertexSize-min(VertexSize))/(max(VertexSize)-min(VertexSize)) # Normalization
  VertexSize <- VertexSize[colnames(transform)]
  gr <- graph_from_adjacency_matrix(transform,mode = "directed",diag = FALSE,weighted=TRUE)
#  gr <- graph_from_adjacency_matrix(transform,mode = "undirected",diag = FALSE,weighted=TRUE)
  gr$layout <- layout_with_fr

#  fc <- cluster_optimal(gr)
#  fc <- cluster_fast_greedy(gr)
#  fc <- cluster_spinglass(gr,spins = 50)
#  fc <- cluster_edge_betweenness(gr)
#  fc <- cluster_leading_eigen(gr)
#  fc <- cluster_louvain(gr)
  fc <- cluster_walktrap (gr,steps=50)
#  fc <- cluster_label_prop(gr)
  plot(fc, gr,
       edge.width = 2*E(gr)$weight,
       vertex.size=VertexSize,
       edge.arrow.size=0.5,
       edge.arrow.width=0.75,
       vertex.label.cex=0.5,
       vertex.label.dist=1,
       main="Subject Association")

par(op)

      varratios <- attr(dataframe_De,"VarRatio")
      names(varratios) <- str_remove_all(names(varratios),"La_")
      fscores <- attr(dataframe_De,"fscore") 
      names(fscores) <- str_remove_all(names(fscores),"La_")
      clustable <- as.data.frame(cbind(Variable=fc$names,
                                       Cluster=fc$membership,
                                       class=classes[fc$names],
                                       ResidualVariance=round(varratios[fc$names],3),
                                       Fscore=round(fscores[fc$names],3),
                                       VertexSize=round(VertexSize[fc$names],3)
                                       )
                                 )
      rownames(clustable) <- str_replace_all(rownames(clustable),"__","_")
      clustable$Variable <- NULL
      clustable$Cluster <- as.integer(clustable$Cluster)
      clustable$ResidualVariance <- as.numeric(clustable$ResidualVariance)
      clustable$Fscore <- as.numeric(clustable$Fscore)
      clustable <- clustable[order(-clustable$ResidualVariance),]
      clustable <- clustable[order(clustable$Cluster),]

pander::pander(as.matrix(clustable))
pander::pander(table(clustable$Cluster,clustable$class))

```

