---
title: "PCA EFA: COVID-19"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")
```

# SALIVA-COVID-19 PCA-EFA-GDSTM

### Loading the libraries

```{r}
library("FRESA.CAD")
library(psych)

library(readxl)
op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)

```



## Data: The COVID_19 Data-Set

The data to process is described in:

<https://zenodo.org/record/4156647#.Y1bSF3bMKUk>


Thermal Saliva Testing Dataset


10.5281/zenodo.4156647
<https://doi.org/10.5281/zenodo.4156647>


I added a column to the data identifying the repeated experiments.

```{r}

SalivaThermal <- as.data.frame(read_excel("~/GitHub/FCA/Data/SalivaThermal_Source_Data_2.xlsx"))


SalivaThermal_set1 <- subset(SalivaThermal,RepID==1)
rownames(SalivaThermal_set1) <- SalivaThermal_set1$ID
SalivaThermal_set1$RepID <- NULL
SalivaThermal_set1$ID <- NULL
SalivaThermal_set1$Ct <- NULL

SalivaThermal_set2 <- subset(SalivaThermal,RepID==2)
rownames(SalivaThermal_set2) <- SalivaThermal_set2$ID
SalivaThermal_set2$RepID <- NULL
SalivaThermal_set2$ID <- NULL
SalivaThermal_set2$Ct <- NULL

SalivaThermal_set3 <- subset(SalivaThermal,RepID==3)
rownames(SalivaThermal_set3) <- SalivaThermal_set3$ID
SalivaThermal_set3$RepID <- NULL
SalivaThermal_set3$ID <- NULL
SalivaThermal_set3$Ct <- NULL

SalivaThermal_Avg <- (SalivaThermal_set1 + SalivaThermal_set2 + SalivaThermal_set3)/3

colnames(SalivaThermal_Avg) <- paste("V",colnames(SalivaThermal_Avg),sep="_")

SalivaThermal_Avg$class <- 1*(str_detect(rownames(SalivaThermal_Avg),"P"))

```

#### Standarize the names for the reporting

```{r results = "asis"}
dataframe <- SalivaThermal_Avg
outcome <- "class"

trainFraction <- 0.5
rhoThreshold <- 0.8
TopVariables <- 5

trainSample <- sample(nrow(dataframe),nrow(dataframe)*trainFraction)

trainDataFrame <- dataframe[trainSample,]
testDataFrame <- dataframe[-trainSample,]

```



```{r results = "asis"}
pander::pander(c(rows=nrow(dataframe),col=ncol(dataframe)-1))
pander::pander(table(dataframe[,outcome]))

varlist <- colnames(dataframe)
varlist <- varlist[varlist != outcome]
varlist <- as.data.frame(cbind(name=varlist,desc=varlist))

```


## Univariate

```{r results = "asis"}

univariate_columns <- c("caseMean","caseStd","controlMean","controlStd","controlKSP","ROCAUC","wilcox.Zvalue")
univar <- uniRankVar(varlist,
	           paste(outcome,"~1"),
	           outcome,
	           testDataFrame,
              rankingTest = "AUC")



```

## Decorrelation with GDSTM Blind

```{r results = "asis"}
DEdataframe <- GDSTMDecorrelation(trainDataFrame,thr=rhoThreshold)
varlistDe <-  colnames(DEdataframe)[colnames(DEdataframe) != outcome];
varlistDe <- as.data.frame(cbind(name=varlistDe,desc=varlistDe))

pander::pander(head(getLatentCoefficients(DEdataframe)))
predTestDe <- predictDecorrelate(DEdataframe,testDataFrame)

univarDe <- uniRankVar(varlistDe,
              paste(outcome,"~1"),
	            outcome,
              predTestDe,
              rankingTest = "AUC")


```

## Decorrelation with GDSTM Driven

```{r results = "asis"}

DriDEdataframe <- GDSTMDecorrelation(trainDataFrame,Outcome=outcome,thr=rhoThreshold)
varlistDe <-  colnames(DriDEdataframe)[colnames(DriDEdataframe) != outcome];
varlistDe <- as.data.frame(cbind(name=varlistDe,desc=varlistDe))

pander::pander(head(getLatentCoefficients(DriDEdataframe)))
predTestDri <- predictDecorrelate(DriDEdataframe,testDataFrame)

univarDeDri <- uniRankVar(varlistDe,
              paste(outcome,"~1"),
	            outcome,
              predTestDri,
              rankingTest = "AUC")


```


## PCA Analysis

```{r results = "asis"}

### PCA 
noclassData <- trainDataFrame[,colnames(trainDataFrame) != outcome]
noclassTestData <- testDataFrame[,colnames(testDataFrame) != outcome]
pc <- principal(noclassData,TopVariables,rotate="varimax")   #principal components
pander::pander(head(pc$loadings))
PCA_Train <- as.data.frame(cbind(predict(pc,noclassData),trainDataFrame[,outcome]))
colnames(PCA_Train)[TopVariables+1] <- outcome

PCA_Predicted <- as.data.frame(cbind(predict(pc,noclassTestData),testDataFrame[,outcome]))
colnames(PCA_Predicted)[TopVariables+1] <- outcome
varlistPCA <-  colnames(PCA_Predicted)[colnames(PCA_Predicted) != "class"];
varlistPCA <- as.data.frame(cbind(name=varlistPCA,desc=varlistPCA))

univarPCA <- uniRankVar(varlistPCA,
              paste(outcome,"~1"),
	            outcome,
              PCA_Predicted)



```

## EFA
```{r results = "asis"}

uls <- fa(noclassData,TopVariables,rotate="varimax")  #unweighted least squares is minres 
pander::pander(head(uls$weights)) 
EFA_Train <- as.data.frame(cbind(predict(uls,noclassData),trainDataFrame[,outcome]))
colnames(EFA_Train)[TopVariables+1] <- outcome
EFA_Predicted <- as.data.frame(cbind(predict(uls,noclassTestData),testDataFrame[,outcome]))
colnames(EFA_Predicted)[TopVariables+1] <- outcome
varlistEFA <-  colnames(EFA_Predicted)[colnames(EFA_Predicted) != "class"];
varlistEFA <- as.data.frame(cbind(name=varlistEFA,desc=varlistEFA))

univarEFA <- uniRankVar(varlistEFA,
              paste(outcome,"~1"),
	            outcome,
              EFA_Predicted)


```

### The tables

```{r results = "asis"}
pander::pander(univar$orderframe[1:TopVariables,univariate_columns])
pander::pander(univarDe$orderframe[1:TopVariables,univariate_columns])
pander::pander(univarDeDri$orderframe[1:TopVariables,univariate_columns])
pander::pander(univarPCA$orderframe[1:TopVariables,univariate_columns])
pander::pander(univarEFA$orderframe[1:TopVariables,univariate_columns])

```

### Model of top five variables

```{r results = "asis", warning = FALSE, dpi=600, fig.height= 5.0, fig.width= 5.0}

lmRAW <- glm(paste(outcome,"~."),
             trainDataFrame[,c(outcome,rownames(univar$orderframe[1:TopVariables,]))],
             family="binomial")
pr <- predictionStats_binary(cbind(testDataFrame[,outcome],predict(lmRAW,testDataFrame)),"Top Raw",cex=0.95)

lmDe <- glm(paste(outcome,"~."),
            DEdataframe[,c(outcome,rownames(univarDe$orderframe[1:TopVariables,]))],
            family="binomial")
pr <- predictionStats_binary(cbind(predTestDe[,outcome],predict(lmDe,predTestDe)),"Top Blind:GDSTM",cex=0.95)

lmDri <- glm(paste(outcome,"~."),
            DriDEdataframe[,c(outcome,rownames(univarDeDri$orderframe[1:TopVariables,]))],
            family="binomial")
pr <- predictionStats_binary(cbind(predTestDe[,outcome],predict(lmDri,predTestDri)),"Top Driven:GDSTM",cex=0.95)


lmPCA <- glm(paste(outcome,"~."),
            PCA_Train,
            family="binomial")
pr <- predictionStats_binary(cbind(PCA_Predicted[,outcome],predict(lmPCA,PCA_Predicted)),"Top PCA",cex=0.95)


lmEFA <- glm(paste(outcome,"~."),
            EFA_Train,
            family="binomial")
pr <- predictionStats_binary(cbind(EFA_Predicted[,outcome],predict(lmEFA,EFA_Predicted)),"Top EFA",cex=0.95)


```

