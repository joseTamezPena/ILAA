---
title: "Decorrelation-Based Feature Discovery: Wisconsin"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")

```


# Effect of UPSTM-Based Decorrelation on Feature Discovery


### Loading the libraries

```{r}
library("FRESA.CAD")
library(readxl)
library(igraph)
library(umap)
library(tsne)
library(entropy)
library(TH.data)
library(psych)
library(whitening)
library("vioplot")
library("rpart")
library(mlbench)

op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)

```

## Material and Methods

Source
W. Nick Street, Olvi L. Mangasarian and William H. Wolberg (1995). An inductive learning approach to prognostic prediction. In A. Prieditis and S. Russell, editors, Proceedings of the Twelfth International Conference on Machine Learning, pages 522–530, San Francisco, Morgan Kaufmann.

Peter Buehlmann and Torsten Hothorn (2007), Boosting algorithms: regularization, prediction and model fitting. Statistical Science, 22(4), 477–505.

## The Data


wpbc {TH.data}

```{r}

data("wpbc", package = "TH.data")
sum(1*(wpbc$status=="R" &  wpbc$time <= 24))
wpbc <- subset(wpbc,time > 36 | (status=="R" & time <= 36))
summary(wpbc$time)
wpbc$status <- 1*(wpbc$status=="R"  & wpbc$time <= 36)
wpbc <- wpbc[complete.cases(wpbc),]
pander::pander(table(wpbc$status))
wpbc$time <- NULL


```




## Comparing IDeA vs PCA vs EFA

### Getting the top correlated variables
```{r results = "asis" ,warning = FALSE, dpi=600, fig.height= 8, fig.width= 11}
#plot(wpbc[,colnames(wpbc)!="status"],col=wpbc$status,cex=0.65,cex.lab=0.5,cex.axis=0.75,cex.sub=0.5,cex.main=0.75)
rawCor <- cor(wpbc[,colnames(wpbc)!="status"])

  gplots::heatmap.2(abs(rawCor),
                    trace = "none",
  #                  scale = "row",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "Original Correlation",
                    cexRow = 0.5,
                    cexCol = 0.5,
                     srtCol=45,
                     srtRow= -45,
                    key.title=NA,
                    key.xlab="Pearson Correlation",
                    xlab="Feature", ylab="Feature")



diag(rawCor) <- 0;
getMaxcor <- apply(rawCor,2,max)
topCorrelated <- getMaxcor[which.max(getMaxcor)]
whotoMax <- getMaxcor[getMaxcor == topCorrelated]
plot(wpbc[,names(whotoMax)],main="Top Correlated variables")

```

### IDeA

```{r results = "asis" ,warning = FALSE, dpi=600, fig.height= 8, fig.width= 11}
IDeAwpbc <- IDeA(wpbc)
#plot(IDeAwpbc[,colnames(IDeAwpbc)!="status"],col=wpbc$status,cex=0.65,cex.lab=0.5,cex.axis=0.75,cex.sub=0.5,cex.main=0.75)
#pander::pander(attr(IDeAwpbc,"UPSTM"))
pander::pander(getLatentCoefficients(IDeAwpbc))


IDeACor <- cor(IDeAwpbc[,colnames(IDeAwpbc)!="status"])


  gplots::heatmap.2(abs(IDeACor),
                    trace = "none",
  #                  scale = "row",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "IDeA Correlation",
                    cexRow = 0.5,
                    cexCol = 0.5,
                     srtCol=45,
                     srtRow= -45,
                    key.title=NA,
                    key.xlab="Pearson Correlation",
                    xlab="Feature", ylab="Feature")


diag(IDeACor) <- 0;
getMaxcor <- apply(IDeACor,2,max)
topCorrelated <- getMaxcor[which.max(getMaxcor)]
whotoMax <- getMaxcor[getMaxcor == topCorrelated]
plot(IDeAwpbc[,names(whotoMax)],main="IDeA: Top Correlated variables")
plot(IDeAwpbc[,c("mean_radius","La_mean_perimeter")],main="IDeA: Top Raw Correlated variables")

```

### PCA

```{r results = "asis" ,warning = FALSE, dpi=600, fig.height= 8, fig.width= 11}
featuresnames <- colnames(wpbc)[colnames(wpbc) != "status"]
pc <- prcomp(wpbc[,featuresnames],center = TRUE,tol=0.01)   #principal components
PCAwpbc <- as.data.frame(cbind(predict(pc,wpbc[,featuresnames]),status=wpbc$status))
#plot(PCAwpbc[,colnames(PCAwpbc)!="status"],col=wpbc$status,cex=0.65,cex.lab=0.5,cex.axis=0.75,cex.sub=0.5,cex.main=0.75)

#pander::pander(pc$rotation)


PCACor <- cor(PCAwpbc[,colnames(PCAwpbc)!="status"])


  gplots::heatmap.2(abs(PCACor),
                    trace = "none",
  #                  scale = "row",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "PCA Correlation",
                    cexRow = 0.5,
                    cexCol = 0.5,
                     srtCol=45,
                     srtRow= -45,
                    key.title=NA,
                    key.xlab="Pearson Correlation",
                    xlab="Feature", ylab="Feature")


```

### EFA


```{r results = "asis" ,warning = FALSE, dpi=600, fig.height= 8, fig.width= 11}
featuresnames <- colnames(wpbc)[colnames(wpbc) != "status"]

uls <- fa(wpbc[,featuresnames],length(colnames(PCAwpbc)),rotate="varimax",warnings=FALSE)  # EFA analysis
EFAwpbc <- as.data.frame(cbind(predict(uls,wpbc[,featuresnames]),status=wpbc$status))
#plot(EFAwpbc[,colnames(EFAwpbc)!="status"],col=wpbc$status,cex=0.65,cex.lab=0.5,cex.axis=0.75,cex.sub=0.5,cex.main=0.75)
#pander::pander(uls$weights)


EFACor <- cor(EFAwpbc[,colnames(EFAwpbc)!="status"])


  gplots::heatmap.2(abs(EFACor),
                    trace = "none",
  #                  scale = "row",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "EFA Correlation",
                    cexRow = 0.5,
                    cexCol = 0.5,
                     srtCol=45,
                     srtRow= -45,
                    key.title=NA,
                    key.xlab="Pearson Correlation",
                    xlab="Feature", ylab="Feature")

```


## Effect on CAR modeling

```{r results = "asis", warning = FALSE, dpi=600, fig.height= 8, fig.width= 11}
par(op)
par(xpd = TRUE)
wpbc$status <- factor(wpbc$status)
rawmodel <- rpart(status~.,wpbc,control=rpart.control(maxdepth=2))
plot(rawmodel,main="Raw",branch=0.5,uniform = TRUE,compress = TRUE,margin=0.1)
text(rawmodel, use.n = TRUE,cex=0.75)
pr <- predict(rawmodel,wpbc,type = "class")
pander::pander(table(wpbc$status,pr))
pander::pander(c(accuracy=sum(wpbc$status==pr)/nrow(wpbc)))

IDeAwpbc$status <- factor(IDeAwpbc$status)
IDeAmodel <- rpart(status~.,IDeAwpbc,control=rpart.control(maxdepth=2))
plot(IDeAmodel,main="IDeA",branch=0.5,uniform = TRUE,compress = TRUE,margin=0.1)
text(IDeAmodel, use.n = TRUE,cex=0.75)
pr <- predict(IDeAmodel,IDeAwpbc,type = "class")
pander::pander(table(IDeAwpbc$status,pr))
pander::pander(c(accuracy=sum(IDeAwpbc$status==pr)/nrow(wpbc)))


PCAwpbc$status <- factor(PCAwpbc$status)
PCAmodel <- rpart(status~.,PCAwpbc,control=rpart.control(maxdepth=2))
plot(PCAmodel,main="PCA",branch=0.5,uniform = TRUE,compress = TRUE,margin=0.1)
text(PCAmodel, use.n = TRUE,cex=0.75)
pr <- predict(PCAmodel,PCAwpbc,type = "class")
pander::pander(table(PCAwpbc$status,pr))
pander::pander(c(accuracy=sum(PCAwpbc$status==pr)/nrow(wpbc)))


EFAwpbc$status <- factor(EFAwpbc$status)
EFAmodel <- rpart(status~.,EFAwpbc,control=rpart.control(maxdepth=2))
plot(EFAmodel,main="EFA",branch=0.5,uniform = TRUE,compress = TRUE,margin=0.1)
text(EFAmodel, use.n = TRUE,cex=0.75)
pr <- predict(EFAmodel,EFAwpbc,type = "class")
pander::pander(table(EFAwpbc$status,pr))
pander::pander(c(accuracy=sum(EFAwpbc$status==pr)/nrow(wpbc)))

par(op)
```


## Effect on logisitc modeling

```{r results = "asis", warning = FALSE, dpi=600, fig.height= 8, fig.width= 11}
wpbc$status <- 1*(wpbc$status == 1)
IDeAwpbc$status <- wpbc$status
PCAwpbc$status <- wpbc$status
EFAwpbc$status <- wpbc$status
rawmodel <- LASSO_MIN(status~.,wpbc,family="binomial")
pander::pander(rawmodel$coef)

IDeAmodel <- LASSO_MIN(status~.,IDeAwpbc,family="binomial")
pander::pander(IDeAmodel$coef)


PCAmodel <- LASSO_MIN(status~.,PCAwpbc,family="binomial")
pander::pander(PCAmodel$coef)


EFAmodel <- LASSO_MIN(status~.,EFAwpbc,family="binomial")
pander::pander(EFAmodel$coef)

par(op)
```





#### Standarize the names for the reporting

```{r results = "asis"}
studyName <- "Wisconsin"
dataframe <- wpbc
outcome <- "status"
thro <- 0.80
TopVariables <- 10
cexheat = 0.25
```




## Generaring the report

```{r parent, child = here::here("~/GitHub/LatentBiomarkers/RMD/Child_univariate/child_Simple_LatentBiomarkers.Rmd")}
```