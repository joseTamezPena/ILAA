---
title: "Decorrelation-Based Feature Discovery: body_fat"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")

```


# Effect of UPSTM-Based Decorrelation on Feature Discovery


### Loading the libraries

```{r}
library("FRESA.CAD")
library(readxl)
library(igraph)
library(umap)
library(tsne)
library(entropy)
library(psych)
library(whitening)
library("vioplot")
library("rpart")

op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)

```

## Material and Methods

Data Source 
https://www.kaggle.com/datasets/fedesoriano/body-fat-prediction-dataset


"Source
The data were generously supplied by Dr. A. Garth Fisher who gave permission to freely distribute the data and use for non-commercial purposes.

Roger W. Johnson
Department of Mathematics & Computer Science
South Dakota School of Mines & Technology
501 East St. Joseph Street
Rapid City, SD 57701

email address: rwjohnso@silver.sdsmt.edu
web address: http://silver.sdsmt.edu/~rwjohnso"


## The Data

```{r}
body_fat <- read.csv("~/GitHub/LatentBiomarkers/Data/BodyFat/BodyFat.csv", header=TRUE)
cexheat = 0.5

#par(cex=0.5)
```

### Removing density as estimator

```{r}
body_fat$Density <- NULL

varlist <- colnames(body_fat)
varlist <- varlist[varlist != "BodyFat"]


```

## Training and testing set

```{r}
trainsamples <- sample(nrow(body_fat),nrow(body_fat)/2)

trainingset <- body_fat[trainsamples,]
testingset <- body_fat[-trainsamples,]
```


#### Correlation Matrix of the Data

The heat map of the data

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}


  par(cex=0.6,cex.main=0.85,cex.axis=0.7)
  cormat <- cor(trainingset[,varlist],method="pearson")
  cormat[is.na(cormat)] <- 0
  gplots::heatmap.2(abs(cormat),
                    trace = "none",
  #                  scale = "row",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "Original Correlation",
                    cexRow = cexheat,
                    cexCol = cexheat,
                     srtCol=45,
                     srtRow=45,
                    key.title=NA,
                    key.xlab="|Pearson Correlation|",
                    xlab="Feature", ylab="Feature")
  diag(cormat) <- 0
  pander::pander(max(abs(cormat)))

```



## Modeling body fat using raw set

```{r}
fatmodel <- LASSO_1SE(BodyFat~.,trainingset);
predbfat <- predict(fatmodel,testingset)
pander::pander(fatmodel$coef)

```


##  Decorrelating using body fat as the outcome

```{r}
trainfat_driven <- IDeA(trainingset,Outcome="BodyFat",thr=0.4)
testfat_driven <- predictDecorrelate(trainfat_driven,testingset)

pander::pander(colnames(trainfat_driven))
theLaFormulas <- getLatentCoefficients(trainfat_driven)
pander::pander(theLaFormulas)
                       
```

#### Correlation Matrix of the Data

The heat map of the decorrelated data

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

varlistDe <- colnames(trainfat_driven)
varlistDe <- varlistDe[varlistDe != "BodyFat"]

  par(cex=0.6,cex.main=0.85,cex.axis=0.7)
  cormat <- cor(trainfat_driven[,varlistDe],method="pearson")
  cormat[is.na(cormat)] <- 0
  gplots::heatmap.2(abs(cormat),
                    trace = "none",
  #                  scale = "row",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "After IDeA Correlation",
                    cexRow = cexheat,
                    cexCol = cexheat,
                     srtCol=45,
                     srtRow=45,
                    key.title=NA,
                    key.xlab="|Pearson Correlation|",
                    xlab="Feature", ylab="Feature")
  diag(cormat) <- 0
  pander::pander(max(abs(cormat)))

```


## Modeling body fat using decorrelated set

```{r}
fatmodel_DE <- LASSO_1SE(BodyFat~.,trainfat_driven);
predbfat_DE <- predict(fatmodel_DE,testfat_driven)
pander::pander(fatmodel_DE$coef)
devCoef <- fatmodel_DE$coef
coefnamesLa <- theLaFormulas[names(devCoef)]
coefnames <- coefnamesLa[!unlist(lapply(coefnamesLa,is.null))]
for (cn in names(coefnames))
{
  names(devCoef)[names(devCoef) %in% cn] <- coefnames[cn]
}
pander::pander(devCoef)

rotmat <- attr(trainfat_driven,"UPSTM")
laBetas <- numeric(ncol(rotmat))
names(laBetas) <- colnames(rotmat)
laBetas[names(fatmodel_DE$coef[-1])] <- fatmodel_DE$coef[-1]
obsBetas <-  c(fatmodel_DE$coef[1],t(rotmat %*% laBetas))
names(obsBetas) <- c("(Intercept)",rownames(rotmat))
obsBetas <- obsBetas[obsBetas!=0]

pander::pander(obsBetas,caption="From Decorrelation Formula")
pander::pander(fatmodel$coef,caption="From Raw Formula")

pred2 <- as.matrix(testingset[,names(obsBetas[-1])]) %*% as.matrix(obsBetas[-1]) + obsBetas[1]
pander::pander(sum((pred2-predbfat_DE)^2))

```

### Comparing the correlation

```{r}
plot(predbfat,testingset$BodyFat,main="Body Fat Prediction",ylab="Body Fat",xlab="Predictor")
pander::pander(cor.test(testingset$BodyFat,predbfat))


plot(predbfat_DE,testingset$BodyFat,main="Body Fat Prediction",ylab="Body Fat",xlab="Predictor")
pander::pander(cor.test(testingset$BodyFat,predbfat_DE))



```



##  Decorrelating using body fat and Age as driven features

```{r}
trainDe <- IDeA(trainingset[,varlist],thr=0.4,drivingFeatures=c("Age"))
trainfat_driven <- predictDecorrelate(trainDe,trainingset)
testfat_driven <- predictDecorrelate(trainDe,testingset)

pander::pander(colnames(trainfat_driven))
theLaFormulas <- getLatentCoefficients(trainDe)
pander::pander(theLaFormulas)
                       
```

#### Correlation Matrix of the Data

The heat map of the decorrelated data

```{r results = "asis", warning = FALSE, dpi=300, fig.height= 5.0, fig.width= 7.0}

varlistDe <- colnames(trainfat_driven)
varlistDe <- varlistDe[varlistDe != "BodyFat"]

  par(cex=0.6,cex.main=0.85,cex.axis=0.7)
  cormat <- cor(trainfat_driven[,varlistDe],method="pearson")
  cormat[is.na(cormat)] <- 0
  gplots::heatmap.2(abs(cormat),
                    trace = "none",
  #                  scale = "row",
                    mar = c(5,5),
                    col=rev(heat.colors(5)),
                    main = "After IDeA Correlation",
                    cexRow = cexheat,
                    cexCol = cexheat,
                     srtCol=45,
                     srtRow=45,
                    key.title=NA,
                    key.xlab="|Pearson Correlation|",
                    xlab="Feature", ylab="Feature")
  diag(cormat) <- 0
  pander::pander(max(abs(cormat)))

```


## Modeling body fat using decorrelated set

```{r}
fatmodel_DE <- LASSO_1SE(BodyFat~.,trainfat_driven);
predbfat_DE <- predict(fatmodel_DE,testfat_driven)
pander::pander(fatmodel_DE$coef)
devCoef <- fatmodel_DE$coef
pander::pander(devCoef)
coefnamesLa <- theLaFormulas[names(devCoef)]
coefnames <- coefnamesLa[!unlist(lapply(coefnamesLa,is.null))]
for (cn in names(coefnames))
{
  names(devCoef)[names(devCoef) %in% cn] <- coefnames[cn]
}
pander::pander(devCoef)


```

### Comparing the correlation

```{r}
plot(predbfat,testingset$BodyFat,main="Body Fat Prediction",ylab="Body Fat",xlab="Predictor")
pander::pander(cor.test(testingset$BodyFat,predbfat))


plot(predbfat_DE,testingset$BodyFat,main="Body Fat Prediction",ylab="Body Fat",xlab="Predictor")
pander::pander(cor.test(testingset$BodyFat,predbfat_DE))

```


