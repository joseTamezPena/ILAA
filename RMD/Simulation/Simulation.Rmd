---
title: "Simulation_Transform"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")
```



# Validating IDeA as metod to recover the transformation matrix structure

We will simulate a set of sparse random transformations, and we test if IDeA is able to recover the inverse transformation
The data will consist of a set of N random variables half Gaussian, half with uniform distribution.
The transformation matrix will only create a set of 10 correlated variables

### Loading the libraries

```{r}
library("FRESA.CAD")
library(entropy)
library(psych)
library(whitening)
library("vioplot")

op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)
source("~/GitHub/LatentBiomarkers/SimulatedDataFunctions.R")

```

### Simulation parameters

```{r}
NUmberofSimulations = 100

## Simulation parameters
NumOfObs  <- 1000
NumOfCorFeatures <- 40
randomToCorrelRatio <- 1
pOfnoZero <- 0.10

## IDeA parameters
thr <- 0.50
method <- "fast"
type <- "LM"

```



## The Data

```{r}

syndata <- SyntheticData(NumOfObs=NumOfObs,
                         NumOfCorFeatures=NumOfCorFeatures,
                         randomToCorrelRatio=randomToCorrelRatio,
                         pOfnoZero=pOfnoZero,
                         noiseLevel=0.1)

```


### IDeA

```{r}

IdeT <- IDeA(syndata$data,corRank=TRUE,thr=thr,verbose=TRUE)
rmat <- attr(IdeT,"UPSTM")
falsedisc <- str_detect(rownames(rmat),"R")
sum(falsedisc)
rmat <- rmat[!falsedisc,]
falsedisc <- str_detect(colnames(rmat),"R")
sum(falsedisc)
rmat <- rmat[,!falsedisc]

rnrotmat <- syndata$rotMatrix
colnames(rnrotmat) <- str_remove_all(colnames(rnrotmat),"La_")
GTassVar <- rnrotmat != 0
GTassVar <- 1*(GTassVar | t(GTassVar))

rnrmat <- rmat
colnames(rnrmat) <- str_remove_all(colnames(rnrmat),"La_")
IDassVar <- rnrmat != 0
IDassVar <- 1*(IDassVar | t(IDassVar))


aux <- IDassVar
IDassVar <- 0*GTassVar
for (rn in rownames(aux))
{
  for (cn in colnames(aux))
  {
    IDassVar[rn,cn] <- aux[rn,cn];
  }
}
diag(IDassVar) <- 1

print(sum(GTassVar==IDassVar)/(ncol(rnrotmat)^2))


```



### Heat map

```{r}
rawCor <- cor(syndata$onlyRotatedData)

  gplots::heatmap.2(abs(rawCor),
                    trace = "none",
                    mar = c(5,5),
                    Rowv = FALSE,
                    Colv = FALSE,
                    col=rev(heat.colors(5)),
                    main = "Pearson Correlation",
                    dendrogram = "none",
                    cexRow = 0.75,
                    cexCol = 0.75,
                    key.title=NA,
                    key.xlab="Coefficients",
                    xlab="Feature", ylab="Feature")

```


### Heat map true rotation

```{r}

gplots::heatmap.2(GTassVar,
                    trace = "none",
                    mar = c(5,5),
                    Rowv = FALSE,
                    Colv = FALSE,
                    col=rev(heat.colors(5)),
                    main = "True Transformation",
                    dendrogram = "none",
                    cexRow = 0.75,
                    cexCol = 0.75,
                    key.title=NA,
                    key.xlab="Coefficients",
                    xlab="Feature", ylab="Feature")

```

### Heat map estimated rotation

```{r}

gplots::heatmap.2(IDassVar,
                    trace = "none",
                    mar = c(5,5),
                    Rowv = FALSE,
                    Colv = FALSE,
                    col=rev(heat.colors(5)),
                    main = "IDeA Transformation",
                    dendrogram = "none",
                    cexRow = 0.75,
                    cexCol = 0.75,
                    key.title=NA,
                    key.xlab="Coefficients",
                    xlab="Feature", ylab="Feature")

```

## Lets run simulations

### Testing the differences in parameters
```{r}


falseDiscoveryT <- numeric(NUmberofSimulations)
DiscoveryAccuracyT <- numeric(NUmberofSimulations)
trainCorT <- numeric(NUmberofSimulations)
testCorT <- numeric(NUmberofSimulations)

falseDiscoveryF <- numeric(NUmberofSimulations)
DiscoveryAccuracyF <- numeric(NUmberofSimulations)
trainCorF <- numeric(NUmberofSimulations)
testCorF <- numeric(NUmberofSimulations)

falseDiscoveryST <- numeric(NUmberofSimulations)
DiscoveryAccuracyST <- numeric(NUmberofSimulations)
trainCorST <- numeric(NUmberofSimulations)
testCorST <- numeric(NUmberofSimulations)

falseDiscoverySF <- numeric(NUmberofSimulations)
DiscoveryAccuracySF <- numeric(NUmberofSimulations)
trainCorSF <- numeric(NUmberofSimulations)
testCorSF <- numeric(NUmberofSimulations)

overlapTF <- numeric(NUmberofSimulations)
overlapSTSF <- numeric(NUmberofSimulations)
overlapTST <- numeric(NUmberofSimulations)
overlapFST <- numeric(NUmberofSimulations)
overlapTSF <- numeric(NUmberofSimulations)
overlapFSF <- numeric(NUmberofSimulations)


i = 1
for (i in 1:NUmberofSimulations)
{
  cat(".")
  if (i %% 10 == 0) cat("\n")
  syndata <- SyntheticData(NumOfObs=NumOfObs,NumOfCorFeatures=NumOfCorFeatures,randomToCorrelRatio=randomToCorrelRatio,pOfnoZero=pOfnoZero)
  
  trainSample <- sample(NumOfObs,NumOfObs/2)
  cat("T")
  evalIDeATRUE <- IDeAEvaluation(traindata=syndata$data[trainSample,],
                                 testdata=syndata$data[-trainSample,],
                                 trueRotation=syndata$rotMatrix,
                                 method=method,
                                 corRank=TRUE,
                                 thr=thr,
                                 type=type)
  trainCorT[i] <- evalIDeATRUE$trainCorrelation
  testCorT[i] <- evalIDeATRUE$testCorrelation
  falseDiscoveryT[i] <- evalIDeATRUE$falseDiscovery
  DiscoveryAccuracyT[i] <- evalIDeATRUE$DiscoveryAccuracy
  

  cat("F")
  evalIDeAFALSE <- IDeAEvaluation(traindata=syndata$data[trainSample,],
                                 testdata=syndata$data[-trainSample,],
                                 trueRotation=syndata$rotMatrix,
                                 method=method,
                                 corRank=FALSE,
                                 thr=thr,
                                 type=type)
  trainCorF[i] <- evalIDeAFALSE$trainCorrelation
  testCorF[i] <- evalIDeAFALSE$testCorrelation
  falseDiscoveryF[i] <- evalIDeAFALSE$falseDiscovery
  DiscoveryAccuracyF[i] <- evalIDeAFALSE$DiscoveryAccuracy
  
  cat("t")
  evalIDeASpearmanT <- IDeAEvaluation(traindata=syndata$data[trainSample,],
                                 testdata=syndata$data[-trainSample,],
                                 trueRotation=syndata$rotMatrix,
                                 method="spearman",
                                 corRank=TRUE,
                                 thr=thr,
                                 type="RLM")
  trainCorST[i] <- evalIDeASpearmanT$trainCorrelation
  testCorST[i] <- evalIDeASpearmanT$testCorrelation
  falseDiscoveryST[i] <- evalIDeASpearmanT$falseDiscovery
  DiscoveryAccuracyST[i] <- evalIDeASpearmanT$DiscoveryAccuracy
  
  cat("f")
  evalIDeASpearmanF <- IDeAEvaluation(traindata=syndata$data[trainSample,],
                                 testdata=syndata$data[-trainSample,],
                                 trueRotation=syndata$rotMatrix,
                                 method="spearman",
                                 corRank=FALSE,
                                 thr=thr,
                                 type="RLM")
  trainCorSF[i] <- evalIDeASpearmanF$trainCorrelation
  testCorSF[i] <- evalIDeASpearmanF$testCorrelation
  falseDiscoverySF[i] <- evalIDeASpearmanF$falseDiscovery
  DiscoveryAccuracySF[i] <- evalIDeASpearmanF$DiscoveryAccuracy

  overlapTF[i] <- sum(evalIDeATRUE$detectedFeatures == evalIDeAFALSE$detectedFeatures)/(nrow(evalIDeATRUE$detectedFeatures)^2)
  overlapSTSF[i] <- sum(evalIDeASpearmanT$detectedFeatures == evalIDeASpearmanF$detectedFeatures)/(nrow(evalIDeATRUE$detectedFeatures)^2)
  overlapTST[i] <- sum(evalIDeATRUE$detectedFeatures == evalIDeASpearmanT$detectedFeatures)/(nrow(evalIDeATRUE$detectedFeatures)^2)
  overlapFST[i] <- sum(evalIDeAFALSE$detectedFeatures == evalIDeASpearmanT$detectedFeatures)/(nrow(evalIDeATRUE$detectedFeatures)^2)
  overlapTSF[i] <- sum(evalIDeATRUE$detectedFeatures == evalIDeASpearmanF$detectedFeatures)/(nrow(evalIDeATRUE$detectedFeatures)^2)
  overlapFSF[i] <- sum(evalIDeAFALSE$detectedFeatures == evalIDeASpearmanF$detectedFeatures)/(nrow(evalIDeATRUE$detectedFeatures)^2)
  
}

boxplot(list(CorRank_T=DiscoveryAccuracyT,CorRank_F=DiscoveryAccuracyF,CorRank_ST=DiscoveryAccuracyST,CorRank_SF=DiscoveryAccuracySF))
boxplot(list(TP=overlapTF,
             STSF=overlapSTSF,
             TST=overlapTST,
             FST=overlapFST,
             TSF=overlapTSF,
             FSF=overlapFSF)
        )
boxplot(list(CorRank_T=trainCorT,CorRank_F=trainCorF,CorRank_ST=trainCorST,CorRank_SF=trainCorSF))
boxplot(list(CorRank_T=testCorT,CorRank_F=testCorF,CorRank_ST=testCorST,CorRank_SF=testCorSF))

```


### Testing the effect of the threshold
```{r}

thrvals <- c(0.20,0.30,0.40,0.50,0.60,0.70,0.80,0.90)

randomToCorrelRatio <- 1
NUmberofSimulations <- 30

falseDiscovery <- matrix(0,nrow=NUmberofSimulations,ncol=length(thrvals))
DiscoveryAccuracy <- falseDiscovery
trainCor <- falseDiscovery
testCor <- falseDiscovery

i = 1
for (i in 1:NUmberofSimulations)
{
  cat(".")
  if (i %% 10 == 0) cat("\n")
  syndata <- SyntheticData(NumOfObs=NumOfObs,NumOfCorFeatures=NumOfCorFeatures,randomToCorrelRatio=randomToCorrelRatio,pOfnoZero=pOfnoZero)
  
  trainSample <- sample(NumOfObs,NumOfObs/2)
  cn <- 1;
  for (thr in thrvals)
  {
    cat("T")
    evalIDeA <- IDeAEvaluation(traindata=syndata$data[trainSample,],
                                   testdata=syndata$data[-trainSample,],
                                   trueRotation=syndata$rotMatrix,
                                   method=method,
                                   corRank=FALSE,
                                   thr=thr,
                                   type=type)
    trainCor[i,cn] <- evalIDeA$trainCorrelation
    testCor[i,cn] <- evalIDeA$testCorrelation
    falseDiscovery[i,cn] <- evalIDeA$falseDiscovery
    DiscoveryAccuracy[i,cn] <- evalIDeA$DiscoveryAccuracy
    cn <- cn + 1;
  }
}
DiscoveryAccuracy <- as.data.frame(DiscoveryAccuracy)
colnames(DiscoveryAccuracy) <- paste("At_",thrvals,sep="")
testCor <- as.data.frame(testCor)
colnames(testCor) <- colnames(DiscoveryAccuracy)

falseDiscovery <- as.data.frame(falseDiscovery)
colnames(falseDiscovery) <- colnames(DiscoveryAccuracy)


boxplot(DiscoveryAccuracy)
boxplot(testCor)
boxplot(falseDiscovery)

```

### Testing the effect of the number of random features
```{r}


randomToCorrelRatios <- c(1,10,100)
NUmberofSimulations <- 30

falseDiscoveryR <- matrix(0,nrow=NUmberofSimulations,ncol=length(randomToCorrelRatios))
DiscoveryAccuracyR <- falseDiscoveryR
trainCorR <- falseDiscoveryR
testCorR <- falseDiscoveryR
thr <- 0.5

i = 1
cn <- 1;
for (rToCRatio in randomToCorrelRatios)
{
  for (i in 1:NUmberofSimulations)
  {
    cat(".")
    if (i %% 10 == 0) cat("\n")
    syndata <- SyntheticData(NumOfObs=NumOfObs,NumOfCorFeatures=NumOfCorFeatures,randomToCorrelRatio=rToCRatio,pOfnoZero=pOfnoZero)
    
    trainSample <- sample(NumOfObs,NumOfObs/2)
    evalIDeA <- IDeAEvaluation(traindata=syndata$data[trainSample,],
                                   testdata=syndata$data[-trainSample,],
                                   trueRotation=syndata$rotMatrix,
                                   method=method,
                                   corRank=FALSE,
                                   thr=thr,
                                   type=type)
    trainCorR[i,cn] <- evalIDeA$trainCorrelation
    testCorR[i,cn] <- evalIDeA$testCorrelation
    falseDiscoveryR[i,cn] <- evalIDeA$falseDiscovery
    DiscoveryAccuracyR[i,cn] <- evalIDeA$DiscoveryAccuracy
  }
  cn <- cn + 1;
}


DiscoveryAccuracyR <- as.data.frame(DiscoveryAccuracyR)
colnames(DiscoveryAccuracyR) <- paste("At_",randomToCorrelRatios,sep="")
testCorR <- as.data.frame(testCorR)
colnames(testCorR) <- colnames(DiscoveryAccuracyR)

falseDiscoveryR <- as.data.frame(falseDiscoveryR)
colnames(falseDiscoveryR) <- colnames(DiscoveryAccuracyR)


boxplot(DiscoveryAccuracyR)
boxplot(testCorR)
boxplot(falseDiscoveryR)

```
